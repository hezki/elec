function err(e,r){throw console.log(util.inspect(r)),new Error(e)}function only(e,r){for(var o={},t=0;t<r.length;t++)r[t]in e&&(o[r[t]]=e[r[t]]);return o}var wait=require("wait.for"),util=require("util"),extend=require("util")._extend,mysql=require("mysql"),mssql=require("mssql"),http=require("http"),yes=require("./yes");fs=require("fs");var private_log_pool;if(fs.existsSync("./logger.json")){var x=fs.readFileSync("./logger.json").toString();private_log_pool=mysql.createPool(JSON.parse(x)),console.log("Logger db init".blue.bold)}module.exports=function(e,r,o){function t(e,r){fs.appendFileSync("app/logs/"+o+"_sql"+(e?"_"+e:"")+".log",(new Date).format()+"	"+r+"\n")}function n(e,r,o){switch(e.type){case"mssql":var t=new mssql.Connection(e,function(n){if(n)throw console.log("err",n,e),n;console.log("mssql connect: ",{pool_id:r,server:e.server,db:e.database});var i=new mssql.Request(t);null===g&&(g=r),h[r]=i,i.conn_a=o});break;default:var n=e.port||3306,i=e.user,l=e.password||e.pass,s=e.db||e.database,a=e.host||e.server,f=mysql.createPool({host:a,port:n,user:i,password:l,database:s,timezone:"GMT+0200",dateStrings:!0,insecureAuth:!0,multipleStatements:!0});f.on("connection",function(){}),h[r]=f,f.conn_a=o,null===y&&(y=r)}f._dbinfo=e}function i(e){return"object"==typeof e?h.indexOf(e):e}function l(e,r){if(!r||!r.length)return e;for(var o=0;o<r.length;o++)if("string"==typeof r[o])e="?"==e[e.indexOf("?")+1]?e.replace("??","[%s]"):e.replace("?","'%s'"),r[o]=r[o].replace("'","''");else if("object"==typeof r[o]){var t=[];for(var n in r[o]){var i=r[o][n];t.push("["+n+"] = "+("string"==typeof i?"'"+i.replace("'","''")+"'":i))}e=e.replace("?","%s"),r[o]=t.join(",")}else e=e.replace("?","%s");return _(e,r)}function s(e,r,o,t,n,i,l){var s;if(s="object"==typeof e?e:{sid:e,ip:r,user:o,tbl:t,row:n,old:i,val:l},!s.tbl||!s.row&&0!==s.row)throw console.log(s),new Error("log info mismatch");s.val&&(s.val=JSON.stringify(s.val)),s.old&&(s.old=JSON.stringify(s.old)),private_log_pool&&private_log_pool.query("insert into site_log set ?",[s],function(e){e&&console.log(e,e.stack)})}function a(e,o,n,s){function a(r){t(e,util.inspect([_,r])),console.log("rst err",{pool_id:e,q:o,prms:n,qp:_})}function f(e){s?g?v.query(_,function(r){return r?e(err):void v.query("select @@IDENTITY as c",function(r,o){return r?e(err):void e(null,o[0].c)})}):v.getConnection(function(r,o){return r?e(r):void o.query(_,function(r,t){return r?(o.release(),e(r)):void o.query("select last_insert_id() as c",function(r,t){return o.release(),r?e(r):void e(null,t[0].c)})})}):v.query(_,e)}var u=arguments,c=0;u.length&&"function"==typeof u[u.length-1]&&(console.log("async call ",e,o,n,u[u.length-1]),c=u[u.length-1],u[u.length-1]=void 0);var p=c?1:0;if(void 0===e)throw new Error("poolid is not valid");e in d&&(e=d[e].pool_id),"object"!=typeof e&&"number"!=typeof e&&e.replace(/[^0-9]+/).length&&(s=n,n=o,o=e,e=0),e=i(e);var v=h[e],g="mssql"==d[v.conn_a].type,y=0;"!"==o.substr(0,1)&&(y=1,o=o.substr(1));try{if(r&&r.pre_proc&&(o=r.pre_proc(o)),n)for(var m=0;m<n.length;m++)if(void 0===n[m])throw new Error("undefined is not valid param value");var _=g?l(o,n):mysql.format(o,n);return y||t(e,_),p?f(function(e,r){e&&a(e),c(e,r)}):wait["for"](f)}catch(b){throw a(b.message?b.message:b),b}}function f(e,o,t){e in d&&(e=d[e].pool_id),"object"!=typeof e&&"number"!=typeof e&&e.replace(/[^0-9]+/).length&&(e=0,t=o,o=e),e=i(e);var n=h[e];return wait["for"](function(e,r){"mssql"==d[n.conn_a].type?n.query("SELECT column_name name,is_nullable as req,data_type as t FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='"+e+"'",function(e,o){if(e)return r(e);for(var e={},t=0;t<o.length;t++)e[o[t].name]={flags:"YES"==o[t].req?1:0,type:o[t].t.indexOf("char")>-1?255:0};r(null,e)}):n.query("select * from "+e+" limit 1",function(e,o,n){if(e)return r(e);if(t){for(var o={},i=0;i<n.length;i++)o[n[i].name]=n[i];return r(e,o)}r(e,n)})},r&&r.pre_proc?r.pre_proc(o):o)}function u(){var e=Array.prototype.slice.call(arguments);return e[0]instanceof http.IncomingMessage||e.splice(0,0,void 0),c.apply(null,e)}function c(e,o,t,n,l,u,c,p){o in d&&(o=d[o].pool_id),"object"!=typeof o&&"number"!=typeof o&&o.replace(/[^0-9]+/).length&&(p=c,c=u,u=l,l=n,n=t,t=o,o=0),o=i(o);var v,g=h[o];if(!g._dbinfo.no_log){if(v={sid:r.glob&&r.glob.C?r.glob.C.sid||0:0,ip:e?e.headers["x-forwarded-for"]||e.ip:"",tbl:r.pre_proc?r.pre_proc(t):t},e){v.ip&&(v.ip=v.ip.replace("::ffff:",""));var y=r.get_login(e);y&&(v.user=y.uid||y.id)}if(u in n&&void 0!==n[u]&&""!==n[u]){var m="select * from "+t+" where ??= ?";v.old=a(g,m,[u,n[u]])[0],v.row=n[u]}}if("string"==typeof l){l=l.split(",");for(var y=0;y<l.length;y++)l[y]=l[y].trim()}var _=only(n,l);if(0==Object.keys(_).length&&Object.keys(n).length>0)throw console.log(n,l),new Error("not found any update fields");var b;for(var q in _)if(_[q]&&"string"==typeof _[q]&&(_[q]=_[q].trim()),_[q]&&"string"==typeof _[q]&&/^\d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d\.\d\d\dZ$/.test(_[q])&&(_[q]=yes.dt2str(_[q])),"mssql"==d[g.conn_a].type);else if(!_[q]&&0!==_[q]&&""!==_[q]&&_[q]!==!1){if(b||(b=f(g,t,1)),!(q in b))throw new Error('fld "'+q+'" not found');if(1&b[q].flags||p&&p.indexOf(q)>-1){if(15!=b[q].type&&252!=b[q].type)throw new Error("fld "+q+" must a value")}else _[q]=null}if(c||(c="select * from "+t+" where ??=?"),u in n&&void 0!==n[u]&&""!==n[u]){var m="update "+t+" set ? where ??= ?";return a(g,m,[_,u,n[u]]),v&&(v.val=_,v.old&&(v.old=only(v.old,Object.keys(_))),s(v)),a(g,c,[u,n[u]])[0]}var w=[];b||(b=f(g,t,1));for(var q in b)w.push(q);_=only(n,w),0==Object.keys(_).length&&Object.keys(n).length>0&&err("not found any updatable fields");for(var q in _)_[q]&&"string"==typeof _[q]&&(_[q]=_[q].trim()),_[q]&&"string"==typeof _[q]&&/^\d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d\.\d\d\dZ$/.test(_[q])&&(_[q]=yes.dt2str(_[q]));if("mssql"==d[g.conn_a].type){var m=[],j=[],E=[];for(var O in _)void 0!==_[O]&&(m.push("["+O+"]"),j.push("?"),E.push(_[O]));m="insert into "+t+" ("+m.join(",")+") values("+j.join(",")+")",_=E}else{var m=Object.keys(_).length?"insert into "+t+" set ?":"insert into "+t+" values()";_=[_]}var S=a(g,m,_,1),x=a(g,c,[u,S])[0];return v&&(v.val=_,v.row=x[u],s(v)),x}var d={};if(e instanceof Array)e.forEach(function(e,r){d[r]=e});else{var p,v=1;for(p in e)if("object"!=typeof e[p]){v=0;break}v?d=e:d[0]=e}var g=null,y=null,h=[],m=0;for(var p in d)n(d[p],m,p),d[p].pool_id=m,m++;var _=require("sprintf-js").vsprintf;return{rst:a,upd:u,log:s,pool:h[0],pools:h,msrst:function(e,r){return a(h[g],e,r)},myrst:function(e,r){return a(h[y],e,r)}}};
//# sourceMappingURL=data.js.map