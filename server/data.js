function err(e,r){throw console.log(util.inspect(r)),new Error(e)}function only(e,r){for(var o={},t=0;t<r.length;t++)r[t]in e&&(o[r[t]]=e[r[t]]);return o}var wait=require("wait.for"),util=require("util"),extend=require("util")._extend,mysql=require("mysql"),mssql=require("mssql"),http=require("http"),yes=require("./yes");fs=require("fs");var private_log_pool=mysql.createPool({host:"localhost",port:3336,user:"logger",password:"power_logger",database:"log",timezone:"GMT+0200",dateStrings:!0,insecureAuth:!0,multipleStatements:!0});module.exports=function(e,r,o){function t(e,r){fs.appendFileSync("app/logs/"+o+"_sql"+(e?"_"+e:"")+".log",(new Date).format()+"	"+r+"\n")}function n(e,r,o){switch(e.type){case"mssql":var t=new mssql.Connection(e,function(n){if(n)throw console.log("err",n,e),n;console.log("mssql connect: ",{pool_id:r,server:e.server,db:e.database});var i=new mssql.Request(t);null===y&&(y=r),h[r]=i,i.conn_a=o});break;default:var n=e.port||3306,i=e.user,l=e.password||e.pass,s=e.db||e.database,a=e.host||e.server,f=mysql.createPool({host:a,port:n,user:i,password:l,database:s,timezone:"GMT+0200",dateStrings:!0,insecureAuth:!0,multipleStatements:!0});f.on("connection",function(){}),h[r]=f,f.conn_a=o,null===g&&(g=r)}f._dbinfo=e}function i(e){return"object"==typeof e?h.indexOf(e):e}function l(e,r){if(!r||!r.length)return e;for(var o=0;o<r.length;o++)if("string"==typeof r[o])e="?"==e[e.indexOf("?")+1]?e.replace("??","[%s]"):e.replace("?","'%s'"),r[o]=r[o].replace("'","''");else if("object"==typeof r[o]){var t=[];for(var n in r[o]){var i=r[o][n];t.push("["+n+"] = "+("string"==typeof i?"'"+i.replace("'","''")+"'":i))}e=e.replace("?","%s"),r[o]=t.join(",")}else e=e.replace("?","%s");return _(e,r)}function s(e,r,o,t,n,i,l){var s;if(s="object"==typeof e?e:{sid:e,ip:r,user:o,tbl:t,row:n,old:i,val:l},!s.tbl||!s.row&&0!==s.row)throw console.log(s),new Error("log info mismatch");s.val&&(s.val=JSON.stringify(s.val)),s.old&&(s.old=JSON.stringify(s.old)),private_log_pool.query("insert into site_log set ?",[s],function(e){e&&console.log(e,e.stack)})}function a(e,o,n,s){function a(r){t(e,util.inspect([_,r])),console.log("rst err",{pool_id:e,q:o,prms:n,qp:_})}function f(e){s?y?v.query(_,function(r){return r?e(err):void v.query("select @@IDENTITY as c",function(r,o){return r?e(err):void e(null,o[0].c)})}):v.getConnection(function(r,o){return r?e(r):void o.query(_,function(r,t){return r?(o.release(),e(r)):void o.query("select last_insert_id() as c",function(r,t){return o.release(),r?e(r):void e(null,t[0].c)})})}):v.query(_,e)}var u=arguments,c=0;u.length&&"function"==typeof u[u.length-1]&&(console.log("async call ",e,o,n,u[u.length-1]),c=u[u.length-1],u[u.length-1]=void 0);var d=c?1:0;if(void 0===e)throw new Error("poolid is not valid");e in p&&(e=p[e].pool_id),"object"!=typeof e&&"number"!=typeof e&&e.replace(/[^0-9]+/).length&&(s=n,n=o,o=e,e=0),e=i(e);var v=h[e],y="mssql"==p[v.conn_a].type,g=0;"!"==o.substr(0,1)&&(g=1,o=o.substr(1));try{if(r&&r.pre_proc&&(o=r.pre_proc(o)),n)for(var m=0;m<n.length;m++)if(void 0===n[m])throw new Error("undefined is not valid param value");var _=y?l(o,n):mysql.format(o,n);return g||t(e,_),d?f(function(e,r){e&&a(e),c(e,r)}):wait["for"](f)}catch(q){throw a(q.message?q.message:q),q}}function f(e,o,t){e in p&&(e=p[e].pool_id),"object"!=typeof e&&"number"!=typeof e&&e.replace(/[^0-9]+/).length&&(e=0,t=o,o=e),e=i(e);var n=h[e];return wait["for"](function(e,r){"mssql"==p[n.conn_a].type?n.query("SELECT column_name name,is_nullable as req,data_type as t FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='"+e+"'",function(e,o){if(e)return r(e);for(var e={},t=0;t<o.length;t++)e[o[t].name]={flags:"YES"==o[t].req?1:0,type:o[t].t.indexOf("char")>-1?255:0};r(null,e)}):n.query("select * from "+e+" limit 1",function(e,o,n){if(e)return r(e);if(t){for(var o={},i=0;i<n.length;i++)o[n[i].name]=n[i];return r(e,o)}r(e,n)})},r&&r.pre_proc?r.pre_proc(o):o)}function u(){var e=Array.prototype.slice.call(arguments);return e[0]instanceof http.IncomingMessage||e.splice(0,0,void 0),c.apply(null,e)}function c(e,o,t,n,l,u,c,d){o in p&&(o=p[o].pool_id),"object"!=typeof o&&"number"!=typeof o&&o.replace(/[^0-9]+/).length&&(d=c,c=u,u=l,l=n,n=t,t=o,o=0),o=i(o);var v,y=h[o];if(!y._dbinfo.no_log){if(v={sid:r.glob&&r.glob.C?r.glob.C.sid||0:0,ip:e?e.headers["x-forwarded-for"]||e.ip:"",tbl:r.pre_proc?r.pre_proc(t):t},e){v.ip&&(v.ip=v.ip.replace("::ffff:",""));var g=r.get_login(e);g&&(v.user=g.uid||g.id)}if(u in n&&void 0!==n[u]&&""!==n[u]){var m="select * from "+t+" where ??= ?";v.old=a(y,m,[u,n[u]])[0],v.row=n[u]}}if("string"==typeof l){l=l.split(",");for(var g=0;g<l.length;g++)l[g]=l[g].trim()}var _=only(n,l);if(0==Object.keys(_).length&&Object.keys(n).length>0)throw console.log(n,l),new Error("not found any update fields");var q;for(var b in _)if(_[b]&&"string"==typeof _[b]&&(_[b]=_[b].trim()),_[b]&&"string"==typeof _[b]&&/^\d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d\.\d\d\dZ$/.test(_[b])&&(_[b]=yes.dt2str(_[b])),"mssql"==p[y.conn_a].type);else if(!_[b]&&0!==_[b]&&""!==_[b]&&_[b]!==!1){if(q||(q=f(y,t,1)),!(b in q))throw new Error('fld "'+b+'" not found');if(1&q[b].flags||d&&d.indexOf(b)>-1){if(15!=q[b].type&&252!=q[b].type)throw new Error("fld "+b+" must a value")}else _[b]=null}if(c||(c="select * from "+t+" where ??=?"),u in n&&void 0!==n[u]&&""!==n[u]){var m="update "+t+" set ? where ??= ?";return a(y,m,[_,u,n[u]]),v&&(v.val=_,v.old&&(v.old=only(v.old,Object.keys(_))),s(v)),a(y,c,[u,n[u]])[0]}var w=[];q||(q=f(y,t,1));for(var b in q)w.push(b);if(_=only(n,w),0==Object.keys(_).length&&Object.keys(n).length>0&&err("not found any updatable fields"),"mssql"==p[y.conn_a].type){var m=[],E=[],j=[];for(var O in _)void 0!==_[O]&&(m.push("["+O+"]"),E.push("?"),j.push(_[O]));m="insert into "+t+" ("+m.join(",")+") values("+E.join(",")+")",_=j}else{var m=Object.keys(_).length?"insert into "+t+" set ?":"insert into "+t+" values()";_=[_]}var S=a(y,m,_,1),A=a(y,c,[u,S])[0];return v&&(v.val=_,v.row=A[u],s(v)),A}var p={};if(e instanceof Array)e.forEach(function(e,r){p[r]=e});else{var d,v=1;for(d in e)if("object"!=typeof e[d]){v=0;break}v?p=e:p[0]=e}var y=null,g=null,h=[],m=0;for(var d in p)n(p[d],m,d),p[d].pool_id=m,m++;var _=require("sprintf-js").vsprintf;return{rst:a,upd:u,log:s,pool:h[0],pools:h,msrst:function(e,r){return a(h[y],e,r)},myrst:function(e,r){return a(h[g],e,r)}}};
//# sourceMappingURL=data.js.map