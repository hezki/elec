"use strict";var util=require("util"),wait=require("wait.for"),express=require("express"),extend=require("extend"),fs=require("fs"),mysql=require("mysql"),request=require("request"),jade=require("jade"),local=function(e){var o={};return{path:e,pop:function(e){return o[e]?o[e]:[]},push:function(e,n){e in o||(o[e]=[]),o[e].push(n)}}};module.exports=function(e,o){function n(){for(var e=[],o=0;o<arguments.length;o++)"number"==typeof arguments[o]||"this"==arguments[o]?e.push(arguments[o]):e.push("'"+arguments[o]+"'");return"$$.emit("+e.join(",")+");return false;"}function s(){for(var e=[],o=0;o<arguments.length;o++)"number"==typeof arguments[o]||"this"==arguments[o]?e.push(arguments[o]):e.push("'"+arguments[o]+"'");return"Yes.set_by_path(this,"+e[0]+(void 0!==e[1]?","+e[1]:"")+(void 0!==e[2]?","+e[2]:"")+")"}var i=o.space,r=e;o&&o.dir&&(r=o.dir);var t=express.Router();t.post("/ajax/:page",function(e,o,n){console.log(e.url.red.bold),o.header("Content-Type","text/html"),e.url=e.url.replace(/^\/ajax/,""),e.method="GET",e.ajax=1,n()}),t.public_urls=[],t.retErr=function(e,o,n){try{console.log("retErr",e,t.UID,e.stack)}catch(s){}throw"string"==typeof e?new Error(e):e},t.pre_proc=function(e){return e||(e=""),e.replace(/(@C\.)([^@]*)(@)/g,function(e,o,n,s){return t.glob.C[n.toUpperCase()]||""})},t.proc=function(){var e=arguments;if("function"==typeof e[0])return t._procf||(t._procf=[]),t._procf.push(e[0]);if(t._procf)for(var o=0;o<t._procf.length;o++)t._procf[o].apply(this,e)};var l,a,p,c,g=e;"/"==g.substr(-1)&&(g=g.substr(0,g.length-1)),t.initdata=function(e){return l=require("./data.js")(e,t,g)},t.initelas=function(e){return require("./elas.js")(e)},t.render=function(e,o,i,l){var a=t.get_login(e.req).uid||0;console.log("render "+o+" by route UID "+(""+t.UID).yellow);var p=function(e,o){var n=e.replace(/\.\./g,"").split(".");if(n.length<2?(e+=".jade",n="jade"):n=n.last(),e="app/projects/"+r+"/"+e,console.log("include: ",e),!fs.existsSync(e))return console.log((e+" not exists").yellow),"";if("jade"==n){var s=extend({},global.app.locals,u,o);return jade.renderFile(e,s)}var s=fs.readFileSync(e).toString();return s},c=local(g);c.on=[],c.on.get=function(){var e={};c.on.forEach(function(o){o[0]in e||(e[o[0]]=[]),e[o[0]].push(o)});var o=[];for(var n in e){var s=[];e[n].forEach(function(e){s.push(e[1].toString().replace(/^function\(\)\{/,"").replace(/\}$/,""))}),o.push('$$.on("'+n+'",function(){'+s.join(";\n")+";\n})\n")}return o},t.glob.C||(t.glob.C={}),t.glob.C.path||(t.glob.C.path=g);var u=extend({},i,{alias:e.req.alias||g,view:o,app:app,ajax:e.req.ajax,login:t.get_login(e.req),C:t.glob.C,uid:a,req:e.req,res:e,ev:n,set:s,local:c,include:p});e.render(r+"/"+o,u,l)},t.redirect=function(e,o){var n=o;if(o.indexOf("//")<0){var s=decodeURI(e.req.originalUrl).split("/");console.log("src reqUrl:"+s.join("/")),s.pop(),s=s.join("/"),n=s+("/"==o.substr(0,1)?"":"/")+o}return n=encodeURI(n),console.log("redirect to:"+n),e.redirect(n)},t.fiber=function(e,o,n){function s(){try{n()}catch(s){t.retErr(s,e,o)}}wait.launchFiber(s)},t.use(function(e,o,n){t.fiber(e,o,n)}),t.check_login=function(e){},t.get_login=function(e){if(!e)throw new Error("must spec req at get_login");return e.session?e.session.login_path&&e.session.login_path[t.path]&&e.session.login_path[t.path].is_login&&e.session.login_path[t.path].login?e.session.login_path[t.path].login:i&&e.session.login_path&&!e.session.login_path[t.path]&&e.session.login_space[i]&&e.session.login_space[i].is_login?(e.session.login_path[g]=e.session.login_space[i],e.session.login_path[t.path].login):{}:{}},t.use(function(o,n,s){if("OPTIONS"==o.method)return s();if(t.public_urls){var r=t.public_urls.filter(function(e){var n=String(o.url).split("?")[0];return e instanceof RegExp?n.match(e):e==n});if(r.length)return console.log("is public:",r[0]),s()}if(o.session.login_path||(o.session.login_path={}),o.session.login_space||(o.session.login_space={}),o.session.login_path[g]&&o.session.login_path[g].is_login)return s();if(i&&o.session.login_space[i]&&o.session.login_space[i].is_login)return o.session.login_path[g]=o.session.login_space[i],console.log(g.yellow.bold+" space "+i+" login"),s();if(a.indexOf(o.ip)>-1){var l=extend({},p);o.session.login_path[g]={},o.session.login_path[g].login=l,o.session.login_path[g].is_login=1,i&&(o.session.login_space[i]=o.session.login_path[g]),console.log("DEBUG_LOGIN")}var c=t.check_login(o);if(void 0!==c){if(c){if("object"!=typeof c)throw new Error("check_login return fail");return o.session.login_path[g]=c,o.session.login_path[g].is_login=1,i&&(o.session.login_space[i]=o.session.login_path[g]),console.log(g.yellow.bold+" check_login login"),s()}return s()}if(/\/login$/.test(o.url)||/\/pass$/.test(o.url)||/\.css$/.test(o.url)||/\.swf$/.test(o.url)||/\.js$/.test(o.url)||/^\/pdf-fonts/.test(o.url))return s();if("GET"==o.method)return o.session.login_target=o.url,console.log("not access to "+o.url.red.bold+", redirect to login"),console.log(o.session.login_path),console.log(i,o.session.login_space),n.redirect("/"+e+"/login");if("/data"==o.url&&o.body&&"public"==o.body.cmd)return s();throw console.log("not access to "+o.url.red.bold),new Error("שגיאת הרשאה, יש להכנס למערכת קודם")}),t.post("/pass",function(e,o){return console.log(e.headers),e.session.login_path||(e.session.login_path={}),e.session.login_path[g]={},e.body&&e.body.name&&e.body.pass?(e.session.login_path[g].name=e.body.name,void c.call(e,e.body.name,e.body.pass,function(n,s){return n?("object"==typeof n&&n.redirect&&(e.session.login_path[g].loginRedirect=n.redirect),e.session.login_path[g].err=n,console.log("login faild".red.bold,n),t.redirect(o,"/login")):(delete e.session.login_path[g].err,e.session.login_path[g].is_login=1,"object"==typeof s?e.session.login_path[g].login=s:e.session.login_path[g].uid=s,console.log("login OK".blue,e.session.login_path),i&&(e.session.login_space[i]=e.session.login_path[g]),void(s&&s.url?t.redirect(s.url):e.session.login_target?t.redirect(o,e.session.login_target):t.redirect(o,"/")))})):t.redirect(o,"/login")}),t.post("/data",function(e,o){if(!(e.session&&e.session.login_path&&e.session.login_path[g]&&e.session.login_path[g].is_login||e.body&&("public"==e.body.cmd||e.isInternal)))return t.retErr("must login before",e,o);e.body&&"{}"!=JSON.stringify(e.body)||t.retErr("req body empty",e,o);var n=function(n,s,i){var r=arguments,a=0,p=l.pools[0];if(l.pools&&"string"==typeof n&&"string"==typeof s)for(var c=0;c<l.pools.length;c++)if(l.pools[c]&&r[a]==l.pools[c].conn_a){a++,p=l.pools[c];break}if(!("connection"in p)&&"string"==typeof r[a])if("select"==r[a].trim().substr(0,6).toLowerCase());else if(!e.isInternal){var g=t.get_login(o.req).uid||0;r[a]="set @val="+g+";\n"+r[a]}return l.rst(r[0],r[1],r[2])},s=function(o,n,s,i,r,t){return l.upd(e,o,n,s,i,r,t)};if("test"==e.body.cmd)return o.json({result:"OK"});try{t.proc(e,o,n,s)}catch(i){t.retErr(i,e,o)}}),t.get("/",function(o,n){n.redirect("/"+e+"/index")}),t.get("/logout",function(e,o){e.session&&e.session.login_path&&delete e.session.login_path[g],i&&e.session&&e.session.login_space&&e.session.login_space[i]&&delete e.session.login_space[i],e.session&&e.session.login_path&&app.serv.forEach(function(o){if(o.space==i){var n="string"==typeof o.path?[o.path]:o.path;n.forEach(function(o){delete e.session.login_path[o]})}}),t.redirect(o,"/")}),t.get(/\/login$/,function(e,o){var n=e.session.login_path&&e.session.login_path[g]?e.session.login_path[g]:{};if(n.is_login)return t.redirect(o,"/");var s=n.err;delete n.err;var i=n.loginRedirect;delete n.loginRedirect,t.render(o,"../share/signin",{loginErr:s,loginRedirect:i,name:n.name,pathToAssets:"/bootstrap-3.0.0",path:g}),delete n.err});var u=require("../projects/"+r+"/"+r+".js")(t,o);return u.C||(u.C={}),u.C.path=g,u.C.directory=r,u.C.config=o,t.glob=u,t.glob.C||(t.glob.C={}),u.DEBUG_IP&&(a="string"==typeof u.DEBUG_IP?[u.DEBUG_IP]:u.DEBUG_IP),p=u.DEBUG_LOGIN,c=u.login,t};
//# sourceMappingURL=route.js.map