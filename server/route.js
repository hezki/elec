"use strict";var util=require("util"),wait=require("wait.for"),express=require("express"),extend=require("extend"),fs=require("fs"),mysql=require("mysql"),request=require("request"),jade=require("jade"),local=function(o){var e={};return{path:o,pop:function(o){return e[o]?e[o]:[]},push:function(o,n){o in e||(e[o]=[]),e[o].push(n)}}};module.exports=function(o,e){function n(){for(var o=[],e=0;e<arguments.length;e++)"number"==typeof arguments[e]||"this"==arguments[e]?o.push(arguments[e]):o.push("'"+arguments[e]+"'");return"$$.emit("+o.join(",")+");return false;"}function s(){for(var o=[],e=0;e<arguments.length;e++)"number"==typeof arguments[e]||"this"==arguments[e]?o.push(arguments[e]):o.push("'"+arguments[e]+"'");return"Yes.set_by_path(this,"+o[0]+(void 0!==o[1]?","+o[1]:"")+(void 0!==o[2]?","+o[2]:"")+")"}var i=express.Router();i.post("/ajax/:page",function(o,e,n){console.log(o.url.red.bold),e.header("Content-Type","text/html"),o.url=o.url.replace(/^\/ajax/,""),o.method="GET",o.ajax=1,n()}),i.public_urls=[],i.retErr=function(o,e,n){try{console.log("retErr",o,i.UID,o.stack)}catch(o){}throw new Error(o)},i.pre_proc=function(o){return o||(o=""),o.replace(/(@C\.)([^@]*)(@)/g,function(o,e,n,s){return i.glob.C[n.toUpperCase()]||""})},i.proc=function(){var o=arguments;if("function"==typeof o[0])return i._procf||(i._procf=[]),i._procf.push(o[0]);if(i._procf)for(var e=0;e<i._procf.length;e++)i._procf[e].apply(this,o)};var r,t,l,a,p=o;"/"==p.substr(-1)&&(p=p.substr(0,p.length-1)),i.initdata=function(o){return r=require("./data.js")(o,i,p)},i.initelas=function(o){return require("./elas.js")(o)},i.render=function(o,e,r,t){var l=i.get_login(o.req).uid||0;console.log("render "+e+" by route UID "+(""+i.UID).yellow);var a=function(o,e){var n=o.replace(/\.\./g,"").split(".");if(n.length<2?(o+=".jade",n="jade"):n=n.last(),o="app/projects/"+p+"/"+o,console.log("include: ",o),!fs.existsSync(o))return console.log((o+" not exists").yellow),"";if("jade"==n){var s=extend({},global.app.locals,c,e);return jade.renderFile(o,s)}var s=fs.readFileSync(o).toString();return s},g=local(p);g.on=[],g.on.get=function(){var o={};g.on.forEach(function(e){e[0]in o||(o[e[0]]=[]),o[e[0]].push(e)});var e=[];for(var n in o){var s=[];o[n].forEach(function(o){s.push(o[1].toString().replace(/^function\(\)\{/,"").replace(/\}$/,""))}),e.push('$$.on("'+n+'",function(){'+s.join(";\n")+";\n})\n")}return e},i.glob.C||(i.glob.C={}),i.glob.C.path||(i.glob.C.path=p);var c=extend({},r,{view:e,app:app,ajax:o.req.ajax,login:i.get_login(o.req),C:i.glob.C,uid:l,req:o.req,res:o,ev:n,set:s,local:g,include:a});o.render(p+"/"+e,c,t)},i.redirect=function(o,e){var n=e;if(e.indexOf("//")<0){var s=decodeURI(o.req.originalUrl).split("/");s.pop(),s=s.join("/"),n=s+("/"==e.substr(0,1)?"":"/")+e}return n=encodeURI(n),console.log("redirect to:"+n),o.redirect(n)},i.fiber=function(o,e,n){function s(){try{n()}catch(s){i.retErr(s,o,e)}}wait.launchFiber(s)},i.use(function(o,e,n){i.fiber(o,e,n)}),i.check_login=function(o){},i.get_login=function(o){if(!o)throw new Error("must spec req at get_login");return o.session?o.session.login_path&&o.session.login_path[i.path]&&o.session.login_path[i.path].is_login&&o.session.login_path[i.path].login?o.session.login_path[i.path].login:e&&o.session.login_path&&!o.session.login_path[i.path]&&o.session.login_space[e]&&o.session.login_space[e].is_login?(o.session.login_path[p]=o.session.login_space[e],o.session.login_path[i.path].login):{}:{}},i.use(function(o,n,s){if("OPTIONS"==o.method)return s();if(i.public_urls){var r=i.public_urls.filter(function(e){var n=String(o.url).split("?")[0];return e instanceof RegExp?n.match(e):e==n});if(r.length)return console.log("is public:",r[0]),s()}if(o.session.login_path||(o.session.login_path={}),o.session.login_space||(o.session.login_space={}),o.session.login_path[p]&&o.session.login_path[p].is_login)return s();if(e&&o.session.login_space[e]&&o.session.login_space[e].is_login)return o.session.login_path[p]=o.session.login_space[e],console.log(p.yellow.bold+" space "+e+" login"),s();if(t.indexOf(o.ip)>-1){var a=extend({},l);o.session.login_path[p]={},o.session.login_path[p].login=a,o.session.login_path[p].is_login=1,e&&(o.session.login_space[e]=o.session.login_path[p]),console.log("DEBUG_LOGIN")}var g=i.check_login(o);if(void 0!==g){if(g){if("object"!=typeof g)throw new Error("check_login return fail");return o.session.login_path[p]=g,o.session.login_path[p].is_login=1,e&&(o.session.login_space[e]=o.session.login_path[p]),console.log(p.yellow.bold+" check_login login"),s()}return s()}if(/\/login$/.test(o.url)||/\/pass$/.test(o.url)||/\.css$/.test(o.url)||/\.swf$/.test(o.url)||/\.js$/.test(o.url)||/^\/pdf-fonts/.test(o.url))return s();if("GET"==o.method)return o.session.login_target=o.url,console.log("not access to "+o.url.red.bold+", redirect to login"),console.log(o.session.login_path),console.log(e,o.session.login_space),i.redirect(n,"/login");if("/data"==o.url&&o.body&&"public"==o.body.cmd)return s();throw console.log("not access to "+o.url.red.bold),new Error("שגיאת הרשאה, יש להכנס למערכת קודם")}),i.post("/pass",function(o,n){return console.log(o.headers),o.session.login_path||(o.session.login_path={}),o.session.login_path[p]={},o.body&&o.body.name&&o.body.pass?(o.session.login_path[p].name=o.body.name,void a(o.body.name,o.body.pass,function(s,r){return s?(o.session.login_path[p].err=s,console.log("login faild".red.bold,s),i.redirect(n,"/login")):(delete o.session.login_path[p].err,o.session.login_path[p].is_login=1,"object"==typeof r?o.session.login_path[p].login=r:o.session.login_path[p].uid=r,console.log("login OK".blue,o.session.login_path),e&&(o.session.login_space[e]=o.session.login_path[p]),void(o.session.login_target?i.redirect(n,o.session.login_target):i.redirect(n,"/")))})):i.redirect(n,"/login")}),i.post("/data",function(o,e){if(!(o.session&&o.session.login_path&&o.session.login_path[p]&&o.session.login_path[p].is_login||o.body&&("public"==o.body.cmd||o.isInternal)))return i.retErr("must login before",o,e);o.body&&"{}"!=JSON.stringify(o.body)||i.retErr("req body empty",o,e);var n=function(n,s,t){var l=arguments,a=0,p=r.pools[0];if(r.pools&&"string"==typeof n&&"string"==typeof s)for(var g=0;g<r.pools.length;g++)if(r.pools[g]&&l[a]==r.pools[g].conn_a){a++,p=r.pools[g];break}if(!("connection"in p)&&"string"==typeof l[a])if("select"==l[a].trim().substr(0,6).toLowerCase());else if(!o.isInternal){var c=i.get_login(e.req).uid||0;l[a]="set @val="+c+";\n"+l[a]}return r.rst(l[0],l[1],l[2])},s=function(e,n,s,i,t,l){return r.upd(o,e,n,s,i,t,l)};if("test"==o.body.cmd)return e.json({result:"OK"});try{i.proc(o,e,n,s)}catch(t){console.log(t),i.retErr(t,o,e)}}),i.get("/",function(o,e){i.redirect(e,"index")}),i.get("/logout",function(o,n){o.session&&o.session.login_path&&delete o.session.login_path[p],e&&o.session&&o.session.login_space&&o.session.login_space[e]&&delete o.session.login_space[e],o.session&&o.session.login_path&&app.serv.forEach(function(n){if(n.space==e){var s="string"==typeof n.path?[n.path]:n.path;s.forEach(function(e){delete o.session.login_path[e]})}}),i.redirect(n,"/")}),i.get(/\/login$/,function(o,e){var n=o.session.login_path&&o.session.login_path[p]?o.session.login_path[p]:{};return n.is_login?i.redirect(e,"/"):void i.render(e,"../share/signin",{loginErr:n.err,name:n.name,pathToAssets:"/bootstrap-3.0.0",path:p})});var g=require("../projects/"+o+"/"+o+".js")(i);return g.C||(g.C={}),g.C.path=p,i.glob=g,i.glob.C||(i.glob.C={}),g.DEBUG_IP&&(t="string"==typeof g.DEBUG_IP?[g.DEBUG_IP]:g.DEBUG_IP),l=g.DEBUG_LOGIN,a=g.login,i};
//# sourceMappingURL=route.js.map