require("date-format-lite");var createDomain=require("domain").create,http=require("http"),request=require("request"),wait=require("wait.for"),Handlebars=require("handlebars"),exec=require("child_process").exec,tmp=require("tmp"),fs=require("fs");Date.masks["default"]="YYYY-MM-DD hh:mm:ss";var wait_request=function(){var e=function(e,r){request.get(e,function(e,t,n){var a;e||(a={response:t,body:n}),r(e,a)})},r=Array.prototype.slice.call(arguments,0);return r.unshift(e),wait["for"].apply(null,r)};module.exports={request:wait_request,strtotime:function(e,r){function t(e,r,t){var n,a=c[r];"undefined"!=typeof a&&(n=a-u.getDay(),0===n?n=7*t:n>0&&"last"===e?n-=7:0>n&&"next"===e&&(n+=7),u.setDate(u.getDate()+n))}function n(e){var r=e.split(" "),n=r[0],a=r[1].substring(0,3),s=/\d+/.test(n),i="ago"===r[2],o=("last"===n?-1:1)*(i?-1:1);if(s&&(o*=parseInt(n,10)),l.hasOwnProperty(a)&&!r[1].match(/^mon(day|\.)?$/i))return u["set"+l[a]](u["get"+l[a]]()+o);if("wee"===a)return u.setDate(u.getDate()+7*o);if("next"===n||"last"===n)t(n,a,o);else if(!s)return!1;return!0}var a,s,i,o,u,c,l,f,p,d,g,w=!1;if(!e)return w;if(e=e.replace(/^\s+|\s+$/g,"").replace(/\s{2,}/g," ").replace(/[\t\r\n]/g,"").toLowerCase(),s=e.match(/^(\d{1,4})([\-\.\/\:])(\d{1,2})([\-\.\/\:])(\d{1,4})(?:\s(\d{1,2}):(\d{2})?:?(\d{2})?)?(?:\s([A-Z]+)?)?$/),s&&s[2]===s[4])if(s[1]>1901)switch(s[2]){case"-":return s[3]>12||s[5]>31?w:new Date(s[1],parseInt(s[3],10)-1,s[5],s[6]||0,s[7]||0,s[8]||0,s[9]||0)/1e3;case".":return w;case"/":return s[3]>12||s[5]>31?w:new Date(s[1],parseInt(s[3],10)-1,s[5],s[6]||0,s[7]||0,s[8]||0,s[9]||0)/1e3}else if(s[5]>1901)switch(s[2]){case"-":return s[3]>12||s[1]>31?w:new Date(s[5],parseInt(s[3],10)-1,s[1],s[6]||0,s[7]||0,s[8]||0,s[9]||0)/1e3;case".":return s[3]>12||s[1]>31?w:new Date(s[5],parseInt(s[3],10)-1,s[1],s[6]||0,s[7]||0,s[8]||0,s[9]||0)/1e3;case"/":return s[1]>12||s[3]>31?w:new Date(s[5],parseInt(s[1],10)-1,s[3],s[6]||0,s[7]||0,s[8]||0,s[9]||0)/1e3}else switch(s[2]){case"-":return s[3]>12||s[5]>31||s[1]<70&&s[1]>38?w:(o=s[1]>=0&&s[1]<=38?+s[1]+2e3:s[1],new Date(o,parseInt(s[3],10)-1,s[5],s[6]||0,s[7]||0,s[8]||0,s[9]||0)/1e3);case".":return s[5]>=70?s[3]>12||s[1]>31?w:new Date(s[5],parseInt(s[3],10)-1,s[1],s[6]||0,s[7]||0,s[8]||0,s[9]||0)/1e3:s[5]<60&&!s[6]?s[1]>23||s[3]>59?w:(i=new Date,new Date(i.getFullYear(),i.getMonth(),i.getDate(),s[1]||0,s[3]||0,s[5]||0,s[9]||0)/1e3):w;case"/":return s[1]>12||s[3]>31||s[5]<70&&s[5]>38?w:(o=s[5]>=0&&s[5]<=38?+s[5]+2e3:s[5],new Date(o,parseInt(s[1],10)-1,s[3],s[6]||0,s[7]||0,s[8]||0,s[9]||0)/1e3);case":":return s[1]>23||s[3]>59||s[5]>59?w:(i=new Date,new Date(i.getFullYear(),i.getMonth(),i.getDate(),s[1]||0,s[3]||0,s[5]||0)/1e3)}if("now"===e)return null===r||isNaN(r)?(new Date).getTime()/1e3|0:0|r;if(!isNaN(a=Date.parse(e)))return a/1e3|0;if(u=r?new Date(1e3*r):new Date,c={sun:0,mon:1,tue:2,wed:3,thu:4,fri:5,sat:6},l={yea:"FullYear",mon:"Month",day:"Date",hou:"Hours",min:"Minutes",sec:"Seconds"},p="(years?|months?|weeks?|days?|hours?|minutes?|min|seconds?|sec|sunday|sun\\.?|monday|mon\\.?|tuesday|tue\\.?|wednesday|wed\\.?|thursday|thu\\.?|friday|fri\\.?|saturday|sat\\.?)",d="([+-]?\\d+\\s"+p+"|(last|next)\\s"+p+")(\\sago)?",s=e.match(new RegExp(d,"gi")),!s)return w;for(g=0,f=s.length;f>g;g++)if(!n(s[g]))return w;return u.getTime()/1e3},str2dt:function(e){if(e=e.split(" "),(e[0].indexOf("/")>-1||e[0].indexOf("."))&&e[0].indexOf("-")<0){var r=e[0].split(/[\/\.]/);2==r.length&&(r[2]=(new Date).getFullYear()),e[0]=r[2]+"-"+r[1]+"-"+r[0]}return e=e.join(" "),new Date(1e3*this.strtotime(e))},dt2str:function(e){function r(e,r){for(var t=e+"";t.length<r;)t="0"+t;return t}function t(e){return r(e,2)}function n(e){var r=Math.abs(e.getTimezoneOffset()),t=String(Math.floor(r/60)),n=String(r%60);return 1==t.length&&(t="0"+t),1==n.length&&(n="0"+n),e.getTimezoneOffset()<0?"+"+t+n:"-"+t+n}var a="yyyy-MM-dd hh:mm:ss";if("string"==typeof e&&arguments.length>1&&(a=arguments[0],e=arguments[1]),"string"==typeof e&&e.replace(/[0\-:\. ]/g,"")&&(e.match(/^([0-9]|0[0-9]|1[0-9]|2[0-3]):[0-5][0-9](:[0-5][0-9]|)$/)&&a.match(/h{1,2}:mm(:ss|)/)&&(e="2000-01-01 "+e),e=module.exports.str2dt(e)),null===e||void 0===e||"string"==typeof e||e.getTime()!==e.getTime())return"";var s=t(e.getDate()),i=t(e.getMonth()+1),o=t(e.getFullYear()),u=t(e.getFullYear().toString().substring(2,4)),c=a.indexOf("yyyy")>-1?o:u,l=t(e.getHours()),f=t(e.getMinutes()),p=t(e.getSeconds()),d=r(e.getMilliseconds(),3),g=n(e),w=a.replace(/dd/g,s).replace(/MM/g,i).replace(/y{1,4}/g,c).replace(/hh/g,l).replace(/mm/g,f).replace(/ss/g,p).replace(/SSS/g,d).replace(/O/g,g);return w},escape:function(e){return e.replace("\\","\\\\").replace("'","\\'").replace('"','\\"').replace("\n","\\\n").replace("\r","\\\r").replace("\x00","\\\x00").replace("","\\")},obj2arr:function(e){var r=[];for(var t in e)"parse"!=t&&"_typeCast"!=t&&r.push(e[t]);return r},arr2obj:function(e,r,t){if(!e||!e.length)return{};var n={};return e.forEach(function(e){if(t){var a=n[e[r]]={};for(var s in t)a[s]=e[t[s]]}else n[e[r]]=e}),n},microTime:function(){var e=process.hrtime();return 1e9*e[0]+e[1]},uuid:function(){var e=module.exports.microTime(),r="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(r){var t=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==r?t:3&t|8).toString(16)});return r},isnum:function(e){return!!("number"==typeof e||"string"==typeof e&&/^[-+]?(\d+|\d+\.\d*|\d*\.\d+)$/.test(e.trim()))},postData:function(e,r,t){var n=(require("events"),new http.IncomingMessage);n.method="POST",n.url="/data",n.originalUrl=n.url,n.path="data",n.params={},n.cookies={},n.headers={},n.body=r,n.query={},n.files={},n.isInternal=!0,0===Object.keys(n.query).length&&(n.query=require("querystring").parse(n.url.split("?")[1])),require("wait.for").launchFiber(function(){var a=createDomain();a.id=a.UID,a.add(n),a.on("error",function(e){t&&t(e)}),a.run(function(){var a=0;e.stack.forEach(function(e){if(!a&&e.regexp&&"/^\\/data\\/?$/i"==e.regexp.toString()){var s={json:function(e){return t?t(null,e):void console.log({who:"internal proc",cmd:r,res:e})}};a=1,e.handle(n,s,function(e,r,n,a){if(e={message:e.message,stack:e.stack},console.log("handle error",e),t)return t(e);throw e})}})})})},createXsl:function(e,r){var t=require("node-xlsx");r instanceof Array||(r=[r]);var n=t.build(r);require("fs").writeFileSync(e,n)},createDoc:function(e,r,t,n){var a=require("jszip"),s=new a;s.load(fs.readFileSync(t));var i=s.file("word/document.xml").asText();i=i.replace(/\{(<[^>]+>)+\{/g,"{{").replace(/\}(<[^>]+>)+\}/g,"}}"),i=i.replace(/\{\{[^\}]*?\}\}/g,function(e){return e.replace(/<[^>]+>/g,"")}),i=i.replace(/\{(<[^>]+>)+\{\{/g,"{{{").replace(/\}\}(<[^>]+>)+\}/g,"}}}"),i=i.replace(/\{\{[^\}]*?\}\}/g,function(e){return e.replace(/<[^>]+>/g,"")}),i=i.split("?>");var o=i[0];i=i[1],fs.writeFileSync("app/temp/test_bef.xml",i);var u='<w:p><w:pPr><w:rPr><w:rtl/></w:rPr></w:pPr><w:r><w:br w:type="page" /></w:r></w:p>';i=i.replace(/(<w:tr>|<w:tr [^>]*>)(((?!(<w:tr>|<w:tr )).)*?)(\{{2,3}#[^\}]*\}{2,3})/g,function(e,r,t,n,a,s){return t.replace(/<[^>]+>/g,"").replace(/\s/g,"")?e:s+r+t}),i=i.replace(/(<w:tc>|<w:tc [^>]*>)(((?!(<w:tc>|<w:tc |<w:tr>|<w:tr |<\/w:tr>|<\/w:tc>)).)*?)(\{{2,3}#[^\}]*\}{2,3})/g,function(e,r,t,n,a,s){return t.replace(/<[^>]+>/g,"").replace(/\s/g,"")?e:s+r+t}),i=i.replace(/(\{{2,3}\/[^\}]*\}{2,3})(((?!\{).)*?<\/w:tr>)/g,function(e,r,t){return t.replace(/<[^>]+>/g,"").replace(/\s/g,"")?e:t+r}),i=i.replace(/(\{{2,3}\/[^\}]*\}{2,3})(((?!\{).)*?<\/w:tc>)/g,function(e,r,t){return t.replace(/<[^>]+>/g,"").replace(/\s/g,"")?e:t+r}),i=i.replace(/<wp:docPr id="\d+"/g,'<wp:docPr id="{{_position}}"');var c=i.indexOf("<w:p"),l=1;Handlebars.registerHelper("_position",function(){return l++}),Handlebars.registerHelper("inc",function(e,r){return parseInt(e)+1}),i.indexOf("<w:tbl")>-1&&i.indexOf("<w:tbl")<c&&(c=i.indexOf("<w:tbl")),i=i.substr(0,c)+"{{#data}}"+i.substr(c),c=i.lastIndexOf("</w:p>")+6,i=i.substr(0,c)+u+"{{/data}}"+i.substr(c),fs.writeFileSync("app/temp/test.xml",i),fs.writeFileSync("app/temp/test.json",JSON.stringify(r));var f=[];n?r.data.forEach(function(e){f.push({fn:e[n],data:{data:[e]}})}):f.push({fn:e,data:r}),f.forEach(function(e){var r=Handlebars.compile(i)(e.data);if(r=r.split(u),r.length>1){var t=r.length-1;r[t].replace(/<[^>]+>/g,"")||(r[t-1]+=r[t],r.splice(t,1))}r=o+"?>"+r.join(u),s.file("word/document.xml",r),fs.writeFileSync(e.fn,s.generate({type:"nodebuffer",compression:"DEFLATE",compressionOptions:{level:9}}))})},timer:function(e){function r(e){if(!e)return process.hrtime();var r=process.hrtime(e);return Math.round(1e3*r[0]+r[1]/1e6)}var t=r(),n=e();return console.log((e.name||"")+" took "+r(t)+"ms"),n},trans:function(e,r,t){function n(e,r,t){if(void 0!==r&&null!==r||(r=""),r=r.toString(),!t)return r;if(!r.match(t))throw new Error("נתון שגוי "+e+": "+r);return r}if(!e||!r)throw"trans call err";var a="function"==typeof t;try{r.card=n("כרטיס",r.card,/^[0-9]{8,16}$/),r.tokef=n("תוקף",r.tokef,/^[0-9]{4,4}$/),r.cvv=n("CVV",r.cvv,/^[0-9]{3,3}$/),r.taz=n("תז",r.taz,/^[0-9]{3,}$/),r.skum=n("סכום",r.skum,/^-{0,1}\d*\.{0,1}\d+$/),r.tas=n("תשלומים",r.tas,/^[0-9]{0,2}$/),r.tas&&(r.tas=1),r.cid=n("אסמכתא",r.cid),r.type||(r.type=4),r.type=n("Type",r.type,/^[24]$/);var s="http://localhost:8080/rec/0/trans.php?UTF=1&CID="+e+"&CLID="+r.cid+"&card="+r.card+"&tokef="+r.tokef+"&skum="+r.skum+"&tas="+r.tas+"&taz="+r.taz+"&cvv="+r.cvv+"&type="+r.type;if(!a){var i=wait_request(s).body;console.log(s,"=",i);var o="000"===i.substr(0,3)?"OK":"err",u={result:o,data:{res:"err"==o?i.substr(4):i,true_num:i.substr(70,7),status:o}};return"err"==o&&(u.error=i.substr(4)),u}request(s,function(e,r,n){if(e)return t(e);var a=n;console.log(s,"=",a);var i="000"===a.substr(0,3)?"OK":"err",o={result:i,data:{res:"err"==i?a.substr(4):a,true_num:a.substr(70,7),status:i}};"err"==i&&(o.error=a.substr(4)),t(e,o)})}catch(c){console.log("trans err",c,a,e),console.log(r);var u={result:"err",error:c.message};if(!a)return u;t(null,u)}},sync:function(e){function r(e){exec("/sync.sh",function(r,t,n){r?e(r):e(null,{out:t,err:n})})}return e?void r(e):wait["for"](r)},proc_file:function(e,r,t){var n=tmp.tmpNameSync();exec(["sox",e,"--rate","8000","-c","1","-t","wav",n].join(" "),function(e,a,s){console.log(s,a),e?(console.log("convert error",e),t&&t("convert error: "+e)):(fs.writeFileSync(r,fs.readFileSync(n)),fs.unlinkSync(n),t&&t())})}};
//# sourceMappingURL=yes.js.map