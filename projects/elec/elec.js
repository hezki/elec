var dns=require("dns"),old=dns.lookup;dns.lookup=function(e,t,s){return"localhost"==e?(s?s:t)(null,"127.0.0.1",4):void old.apply(this,arguments)};var yes=require("../../server/yes"),request=require("request"),fs=require("fs"),wait=require("wait.for");module.exports=function(e){var t,s={host:"localhost",port:3306,user:"root",pass:"power001",db:"electric"},r="http://localhost/server.php",a=0;if(e.public_urls.push("/info"),"3390"==global.app.get("port")){if(app.get("/",function(e,t){t.redirect("/elec/info")}),fs.existsSync("./server.json")){var o=fs.readFileSync("./server.json").toString();s={mysql:s,server:JSON.parse(o)},a=1}}else if(fs.existsSync("./server.json")){var o=fs.readFileSync("./server.json").toString();s=JSON.parse(o),s.url&&(r=s.url)}var n=e.initdata(s),c={C:{TITLE:"מפקד החשמל"},DEBUG_IP:[],DEBUG_LOGIN:{},data:n,login:function(e,t,s){try{if(a){var r=n.rst("server","select * from db_0.elec_users where name=? and pass=?",[e,t])[0];return r?s(null,{uid:r.id,uuid:r.uuid}):s("שם משתמש או סיסמא שגויים.ס1")}if(fs.existsSync("./client.id")){var o=fs.readFileSync("./client.id").toString().replace(/[\r\n-ba]/g);"f38953342465785710421f0"==o&&s(null,{man:1})}var c=n.rst('select val from global where name="user1"')[0];if(!c)return s("שם משתמש או סיסמא שגויים.1");if(c=c.val,c!=e)return s("שם משתמש או סיסמא שגויים.2");var d=n.rst('select val from global where name="user1_pass"')[0];if(!d)return s("שם משתמש או סיסמא שגויים.3");if(d=d.val,d!=t)return s("שם משתמש או סיסמא שגויים.4");s(null,{uid:1})}catch(i){console.log("login err",i),s("שגיאת שרת")}}},d={};if(a){console.log("server mode".yellow.bold);var i=require("socket.io")(1117);setInterval(function(){Object.keys(d).forEach(function(e){var t=d[e];t&&t.connected&&t.emit("ping")})},3e4),i.on("connection",function(e){e.on("socket_test",function(e,t){console.log("socket_test",e),t(e)}),e.on("ping",function(t){e._uuid&&t==e._uuid||e.emit("what")}),e.on("uuid",function(t){function s(){try{e._uuid=t;var s=n.rst("server","select * from db_0.elec_users where uuid=?",[t])[0];if(!s)throw new Error(t+" is not valid UUID");d[t]=e,d[t]._cname=s.client,n.rst("server","update db_0.elec_users set status=1 where uuid=?",[t]),console.log("client "+s.client+" connect".yellow.bold)}catch(r){console.log("ERR",r)}}console.log("client "+t+" request connect".blue.bold),d[t]?setTimeout(function(){wait.launchFiber(s)},3e4):wait.launchFiber(s)}),e.on("disconnect",function(){function t(){try{if(!e._uuid)return;var t=e._uuid,s=n.rst("server","select * from db_0.elec_users where uuid=?",[t])[0];if(!s)throw new Error(t+" is not valid UUID");delete d[t],n.rst("server","update db_0.elec_users set status=0 where uuid=?",[t]),console.log("client "+s.client+" disconnect".red.bold)}catch(r){console.log("ERR",r)}}wait.launchFiber(t)})}),e.unload=function(){i.close()}}else if(fs.existsSync("./client.id")){i=require("socket.io-client").connect("http://mefaked.com:1117",{forceNew:!0,transports:["websocket"]});var o=fs.readFileSync("./client.id").toString();console.log("client mode: "+o.yellow.bold);var l;setInterval(function(){l=setTimeout(function(){i.disconnect(),i.connect("http://mefaked.com:1117",{forceNew:!0,transports:["websocket"]})},3e3),i.emit("PING",o)},1e4),i.on("PONG",function(){clearTimeout(l)}),i.on("what",function(){i.emit("uuid",o),console.log("c side connect:"+o)}),i.on("connect",function(){i.emit("uuid",o),console.log("c side connect:"+o)}),i.on("disconnect",function(){console.log("c side disconnect")}),i.on("socket_test",function(e,t){t(e)}),i.on("req",function(t,s){console.log("req".green+", body: "+JSON.stringify(t).substr(0,500)),yes.postData(e,t,function(e,t){try{if(console.log("return "+(e?"err":"OK")),e)return console.log(e,e.stack),void s({result:"err",err:e.message,stack:e.stack});s(t)}catch(r){console.log(r,r.stack),s({result:"err",err:r&&r.message?r.message:r})}})}),t=i,i._uuid=o,e.unload=function(){i.disconnect()}}return e.proc(function(s,o,n,c){function i(t){e.retErr(t,s,o)}var l=e.get_login(s),m=s.body;if(a){var u=l.uuid;if(console.log("send cmd to client",JSON.stringify(m).substr(0,100)),!u)return i("ACCESS DENIED");if(d[u]||i("שרת לא זמין"),m.cmd&&"socket_test"==m.cmd){var f=setTimeout(function(){i("שרת לא הגיב בזמן")},2e3);return void d[u].emit("socket_test",yes.uuid(),function(e){clearTimeout(f),o.json(e)})}var f=setTimeout(function(){i("שרת לא הגיב בזמן")},15e3);return void d[u].emit("req",m,function(e){clearTimeout(f),o.json(e)})}if(m&&!m.localy)return void request({url:r,method:"POST",body:JSON.stringify(s.body)},function(e,t,s){if(e)return i(e);t.headers["x-chromelogger-data"]&&o.setHeader("X-ChromeLogger-Data",t.headers["x-chromelogger-data"]);try{var a=JSON.parse(s)}catch(n){throw console.log(r,n,s),new Error(s)}if("error"==a.result)return i(a.error);var c=a.data;return delete a.data,"bak"==m.cmd?o.redirect("http://localhost/baks/"+c):void o.json({result:"OK",data:c,all:a})});var h={result:"OK"},m=s.body;switch(m.cmd){case"socket_test":if(t)return void t.emit("socket_test",t._uuid,function(e){h.data=e,e.json(h)});i("not connect");break;case"init":h.data={switchs:n("select * from switchs order by ord,name"),matcons:n("select * from matcons order by ord,name"),grps:n("select * from grps order by id")},h.data.grps[0]||(h.data.grps[0]="בסיסי");break;case"hand_cmds":switch(m.type){case"del":var y=yes.dt2str("yyy-MM-dd",yes.str2dt(m.date)),p=n("select * from days where grp=0 and date=?",[y])[0];p||i("not found date");var g=JSON.parse(p.hands);if(g){var b=yes.dt2str("hh:mm:ss",yes.str2dt(y+" "+m.t)),w=m.s,v=m.a,k=m.r?1:0,_=[];g.forEach(function(e){e.r&&!k||!e.r&&k?_.push(e):yes.dt2str("hh:mm:ss",yes.str2dt(y+" "+e.t))==b&&e.s==w&&e.a==v||_.push(e)}),n("update days set hands=? where id=?",[JSON.stringify(_),p.id])}break;case"add":m.date&&"now"==m.date&&(m.date=yes.dt2str(new Date)),m.on&&"now"==m.on&&(m.on=yes.dt2str(new Date)),m.off&&"now"==m.off&&(m.off=yes.dt2str(new Date));var g,y=yes.dt2str("yyy-MM-dd",yes.str2dt(m.date)),p=n("select * from days where grp=0 and date=?",[y])[0],S=yes.dt2str("yyyy-MM-dd",new Date(yes.str2dt(m.date).getTime()+864e5)),O=n("select * from days where grp=0 and date=?",[S])[0],E=null;p?g=JSON.parse(p.hands):n('insert into days(date,grp)values("'+y+'",0)'),g||(g=[]),m.src&&(g=g.filter(function(e){return console.log(e.src,m.src,e.src!=m.src),e.src!=m.src})),m.on&&g.push({s:m.s,a:1,t:yes.dt2str("hh:mm:ss",yes.str2dt(m.on))}),m.off&&g.push({s:m.s,a:2,t:yes.dt2str("hh:mm:ss",yes.str2dt(m.off))});m.proc&&m.proc.forEach(function(e){if(e.t&&e.e){var t=yes.dt2str("yyyy-MM-dd",new Date),s=yes.str2dt(t+" "+e.t),r="00:00:00"!=e.e&&"0:00:00"!=e.e?yes.str2dt(t+" "+e.e):new Date(yes.str2dt(t).getTime()+864e5);if(s>r){var a=JSON.parse(JSON.stringify(e));r=new Date(r.getTime()+864e5),e.e="00:00:00";var o=e.src.split("-");e.src=o&&o[0]?o[0]+"-00":e.src,O||(n('insert into days(date,grp,hands)values("'+S+'",0,"'+JSON.stringify([])+'")'),O=n("select * from days where grp=0 and date=?",[S])[0]),E||(E=O.hands?JSON.parse(O.hands):[]),a.t="00:00:00",a.e=yes.dt2str("hh:mm:ss",r),a.src=o&&o[1]?a.a+"_00-"+o[1]:a.src,E.push(a)}}g.push(e)}),n("update days set hands=? where grp=0 and date=?",[JSON.stringify(g),y]),E&&n("update days set hands=? where grp=0 and date=?",[JSON.stringify(E),S]);break;default:i("param err")}break;case"share":var N=n("select * from cmds"),j=yes.arr2obj(N,"id");N.forEach(function(e){e.key=[e.type,e.zman,e.action,e.time,e.days].join("_")});var q=j[m.src];srck=q.key,src_ms=q.matcon+"_"+q["switch"];var J={};N.forEach(function(e){e.key==srck&&(J[e.matcon+"_"+e["switch"]]=e.id)});var D={},T={};q.share?n("select * from cmds where share=?",[q.share]).forEach(function(e){D[e.matcon+"_"+e["switch"]]=e.id}):(q.share=n("select max(share) c from cmds")[0].c+1,n("update cmds set share=? where id=?",[q.share,q.id]));var x={type:q.type,zman:q.zman,action:q.action,time:q.time,days:q.days,share:q.share};m.m.push(q.matcon),m.s.push(q["switch"]),m.m.forEach(function(e){m.s.forEach(function(t){e+"_"+t!=src_ms&&(T[e+"_"+t]||(T[e+"_"+t]=1,x.id=D[e+"_"+t],x.id||(x.id=J[e+"_"+t]),x.matcon=e,x["switch"]=t,c("cmds",x,"switch, matcon,type,zman,action, time, days,share","id"),delete D[e+"_"+t]))})}),delete D[src_ms],Object.keys(D).forEach(function(e){n("delete from cmds where id=?",[D[e]])}),Object.keys(T).length||n("update cmds set share=0 where id=?",[q.id]),console.log(src_ms);break;case"list":switch(m.type){case"zmanim":h.data=n("select  id,name from zmanim order by ord,name");break;case"cmds":h.data=n("select * from cmds where matcon=? and switch=?",[m.m,m.s]);break;case"grps":h.data=n("select * from grps order by id");break;case"settings":var z=h.data=[];n("select * from global").forEach(function(e){z.push({name:e.name,desc:e.notes,val:e.val})}),n("select * from grps order by id").forEach(function(e){z.push({name:"grp_"+e.id,desc:"שם קבוצה "+e.id,val:e.name})});break;case"matcons":"grp"in m?h.data=n("select * from matcons where grp=? order by ord,name",[m.grp]):h.data=n("select * from matcons order by ord,name");break;case"summer":h.data=n("select * from summer order by year");break;case"rules":h.data=n("select * from rules where grp=? ",[m.grp]);break;case"switchs":"grp"in m?h.data=n("select * from switchs where grp=? order by ord,name",[m.grp]):h.data=n("select id,name,grp from switchs order by ord,name");break;case"share":var z={m:{},s:{}};n("select * from cmds where share=?",[m.grp]).forEach(function(e){z.m[e.matcon]=1,z.s[e["switch"]]=1}),h.data={m:Object.keys(z.m),s:Object.keys(z.s)};break;case"tmp":var z=n("select hands from days where grp=0 and date=?",[m.date])[0];h.data=z?JSON.parse(z.hands):[];break;default:i(m.type+" is not valid type",s)}break;case"upd":switch(m.type){case"times":h.data=c("zmanim",m.data,"name,base,igul,add,ord","id");break;case"settings":"grp"==m.k.split("_")[0]?(m.k.split("_")[1]||i("params missing"),c("grps",{id:m.k.split("_")[1],name:m.v},"name","id")):c("global",{name:m.k,val:m.v},"val","name");break;case"summer":h.data=c("summer",m.data,"year,begin,end","id");break;case"rules":h.data=c("rules",m.data,"grp,desc,cal_type,begin_m, begin_d,end_m, end_d,params, days,ord","id");break;case"matcons":m.data.color&&"#"==m.data.color[0]&&(m.data.color=m.data.color.substr(1)),h.data=c("matcons",m.data,"name,color,ord","id"),h.data.color="#"+h.data.color;break;case"switchs":h.data=c("switchs",m.data,"out,name,disable,ord,locked,lock_status","id");break;case"cmds":if(m.data.id){var z=n("select * from cmds where id=?",[m.data.id])[0],I=z.share?"share="+z.share:"id="+z.id;delete m.data.id,n("update cmds set ? where "+I,[m.data]),h.data=n("select * from cmds where id=?",[z.id])[0]}else h.data=c("cmds",m.data,"switch, matcon,type,zman,action, time, days","id");break;default:i(m.type+" is not valid type",s)}break;case"del":switch(m.tbl){case"times":n("delete from cmds where type in(1,2) and  zman=?",[m.id]),n("delete from zmanim where id=?",[m.id]);break;case"rules":n("delete from rules where id=?",[m.id]);break;case"cmds":h.data=0;var z=n("select * from cmds where id=?",[m.id])[0];n("delete from cmds where id=?",[m.id]),z&&z.share&&1==n("select count(*) as c from cmds where share=?",[z.share])[0].c&&(n("update cmds set share=0 where share=?",[z.share]),h.data=1);break;case"switchs":n("delete from switchs where id=?",[m.id]),n("delete from cmds where switch=?",[m.id]);break;default:i(m.tbl+" is not valid tbl",s)}break;case"reset":switch(m.type){case"matcon":n("delete from cmds where matcon=? and switch=?",[m.m,m.s]);break;default:i(m.type+" is not valid type")}break;default:i(m.cmd+" is not valid request",s)}o.json(h)}),e.get("/bak",function(t,s){t.body={cmd:"bak"},e.proc(t,s)}),e.get("/index",function(t,s){e.render(s,"status")}),e.get("/sample",function(t,s){e.render(s,"projs",{userName:t.session.login.name,data:n.rst("select * from 0_projects order by id desc")})}),e.get("/man",function(t,s){var r=e.get_login(t);return r.man?void 0:e.redirect(t,"/index")}),c};
//# sourceMappingURL=elec_remote.js.map