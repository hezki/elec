var dns=require("dns"),old=dns.lookup;dns.lookup=function(e,r,s){return"localhost"==e?(s?s:r)(null,"127.0.0.1",4):void old.apply(this,arguments)};var yes=require("../../server/yes"),request=require("request"),fs=require("fs"),wait=require("wait.for");module.exports=function(e){var r,s={host:"localhost",port:3306,user:"root",pass:"power001",db:"electric"},t="http://localhost/server.php",a=0;if(e.public_urls.push("/info"),"3390"==global.app.get("port")){if(app.get("/",function(e,r){r.redirect("/elec/info")}),fs.existsSync("./server.json")){var o=fs.readFileSync("./server.json").toString();s={mysql:s,server:JSON.parse(o)},a=1}}else if(fs.existsSync("./server.json")){var o=fs.readFileSync("./server.json").toString();s=JSON.parse(o),s.url&&(t=s.url)}var c=e.initdata(s),n={C:{TITLE:"מפקד החשמל"},DEBUG_IP:[],DEBUG_LOGIN:{},data:c,login:function(e,r,s){try{if(a){var t=c.rst("server","select * from db_0.elec_users where name=? and pass=?",[e,r])[0];return t?s(null,{uid:t.id,uuid:t.uuid}):s("שם משתמש או סיסמא שגויים.ס1")}if(fs.existsSync("./client.id")){var o=fs.readFileSync("./client.id").toString().replace(/[\r\n-ba]/g);"f38953342465785710421f0"==o&&s(null,{man:1})}var n=c.rst('select val from global where name="user1"')[0];if(!n)return s("שם משתמש או סיסמא שגויים.1");if(n=n.val,n!=e)return s("שם משתמש או סיסמא שגויים.2");var d=c.rst('select val from global where name="user1_pass"')[0];if(!d)return s("שם משתמש או סיסמא שגויים.3");if(d=d.val,d!=r)return s("שם משתמש או סיסמא שגויים.4");s(null,{uid:1})}catch(i){console.log("login err",i),s("שגיאת שרת")}}},d={};if(a){console.log("server mode".yellow.bold);var i=require("socket.io")(1117);setInterval(function(){d.forEach(function(e){e&&e.connected&&e.emit("ping")})},3e4),i.on("connection",function(e){e.on("socket_test",function(e,r){console.log("socket_test",e),r(e)}),e.on("ping",function(r){e._uuid&&r==e._uuid||e.emit("what")}),e.on("uuid",function(r){function s(){try{e._uuid=r;var s=c.rst("server","select * from db_0.elec_users where uuid=?",[r])[0];if(!s)throw new Error(r+" is not valid UUID");d[r]=e,c.rst("server","update db_0.elec_users set status=1 where uuid=?",[r]),console.log("client "+s.client+" connect".yellow.bold)}catch(t){console.log("ERR",t)}}wait.launchFiber(s)}),e.on("disconnect",function(){function r(){try{if(!e._uuid)return;var r=e._uuid,s=c.rst("server","select * from db_0.elec_users where uuid=?",[r])[0];if(!s)throw new Error(r+" is not valid UUID");delete d[r],c.rst("server","update db_0.elec_users set status=0 where uuid=?",[r]),console.log("client "+s.client+" disconnect".red.bold)}catch(t){console.log("ERR",t)}}wait.launchFiber(r)})}),e.unload=function(){i.close()}}else if(fs.existsSync("./client.id")){var o=fs.readFileSync("./client.id").toString();console.log("client mode: "+o.yellow.bold);var i=require("socket.io-client").connect("http://mefaked.com:1117",{forceNew:!0,transports:["websocket"]});i.on("ping",function(){}),i.on("what",function(){i.emit("uuid",o),console.log("c side connect:"+o)}),i.on("connect",function(){i.emit("uuid",o),console.log("c side connect:"+o)}),i.on("disconnect",function(){console.log("c side disconnect")}),i.on("socket_test",function(e,r){r(e)}),i.on("req",function(r,s){console.log("req".green+", body: "+JSON.stringify(r).substr(0,500)),yes.postData(e,r,function(e,r){try{if(console.log("return "+(e?"err":"OK")),e)return console.log(e,e.stack),void s({result:"err",err:e.message,stack:e.stack});s(r)}catch(t){console.log(t,t.stack),s({result:"err",err:t&&t.message?t.message:t})}})}),r=i,i._uuid=o,e.unload=function(){i.disconnect()}}return e.proc(function(s,o,c,n){function i(r){e.retErr(r,s,o)}var l=e.get_login(s),m=s.body;if(a){var u=l.uuid;if(console.log("send cmd to client",JSON.stringify(m).substr(0,100)),!u)return i("ACCESS DENIED");if(d[u]||i("שרת לא זמין"),m.cmd&&"socket_test"==m.cmd){var f=setTimeout(function(){i("שרת לא הגיב בזמן")},2e3);return void d[u].emit("socket_test",yes.uuid(),function(e){clearTimeout(f),o.json(e)})}var f=setTimeout(function(){i("שרת לא הגיב בזמן")},15e3);return void d[u].emit("req",m,function(e){clearTimeout(f),o.json(e)})}if(m&&!m.localy)return void request({url:t,method:"POST",body:JSON.stringify(s.body)},function(e,r,s){if(e)return i(e);r.headers["x-chromelogger-data"]&&o.setHeader("X-ChromeLogger-Data",r.headers["x-chromelogger-data"]);try{var a=JSON.parse(s)}catch(c){throw console.log(t,c,s),new Error(s)}if("error"==a.result)return i(a.error);var n=a.data;return delete a.data,"bak"==m.cmd?o.redirect("http://localhost/baks/"+n):void o.json({result:"OK",data:n,all:a})});var h={result:"OK"},m=s.body;switch(m.cmd){case"socket_test":if(r)return void r.emit("socket_test",r._uuid,function(e){h.data=e,e.json(h)});i("not connect");break;case"init":h.data={switchs:c("select * from switchs order by ord,name"),matcons:c("select * from matcons order by ord,name"),grps:c("select * from grps order by id")},h.data.grps[0]||(h.data.grps[0]="בסיסי");break;case"hand_cmds":switch(m.type){case"del":var p=yes.dt2str("yyy-MM-dd",yes.str2dt(m.date)),y=c("select * from days where grp=0 and date=?",[p])[0];y||i("not found date");var g=JSON.parse(y.hands);if(g){var b=yes.dt2str("hh:mm:ss",yes.str2dt(p+" "+m.t)),w=m.s,v=m.a,k=m.r?1:0,_=[];g.forEach(function(e){e.r&&!k||!e.r&&k?_.push(e):yes.dt2str("hh:mm:ss",yes.str2dt(p+" "+e.t))==b&&e.s==w&&e.a==v||_.push(e)}),c("update days set hands=? where id=?",[JSON.stringify(_),y.id])}break;case"add":m.date&&"now"==m.date&&(m.date=yes.dt2str(new Date)),m.on&&"now"==m.on&&(m.on=yes.dt2str(new Date)),m.off&&"now"==m.off&&(m.off=yes.dt2str(new Date));var g,p=yes.dt2str("yyy-MM-dd",yes.str2dt(m.date)),y=c("select * from days where grp=0 and date=?",[p])[0];y?g=JSON.parse(y.hands):c('insert into days(date,grp)values("'+p+'",0)'),g||(g=[]),m.src&&(g=g.filter(function(e){return console.log(e.src,m.src,e.src!=m.src),e.src!=m.src})),m.on&&g.push({s:m.s,a:1,t:yes.dt2str("hh:mm:ss",yes.str2dt(m.on))}),m.off&&g.push({s:m.s,a:2,t:yes.dt2str("hh:mm:ss",yes.str2dt(m.off))}),m.proc&&m.proc.forEach(function(e){g.push(e)}),c("update days set hands=? where grp=0 and date=?",[JSON.stringify(g),p]);break;default:i("param err")}break;case"share":var S=c("select * from cmds"),E=yes.arr2obj(S,"id");S.forEach(function(e){e.key=[e.type,e.zman,e.action,e.time,e.days].join("_")});var O=E[m.src];srck=O.key,src_ms=O.matcon+"_"+O["switch"];var j={};S.forEach(function(e){e.key==srck&&(j[e.matcon+"_"+e["switch"]]=e.id)});var q={},N={};O.share?c("select * from cmds where share=?",[O.share]).forEach(function(e){q[e.matcon+"_"+e["switch"]]=e.id}):(O.share=c("select max(share) c from cmds")[0].c+1,c("update cmds set share=? where id=?",[O.share,O.id]));var D={type:O.type,zman:O.zman,action:O.action,time:O.time,days:O.days,share:O.share};m.m.push(O.matcon),m.s.push(O["switch"]),m.m.forEach(function(e){m.s.forEach(function(r){e+"_"+r!=src_ms&&(N[e+"_"+r]||(N[e+"_"+r]=1,D.id=q[e+"_"+r],D.id||(D.id=j[e+"_"+r]),D.matcon=e,D["switch"]=r,n("cmds",D,"switch, matcon,type,zman,action, time, days,share","id"),delete q[e+"_"+r]))})}),delete q[src_ms],Object.keys(q).forEach(function(e){c("delete from cmds where id=?",[q[e]])}),Object.keys(N).length||c("update cmds set share=0 where id=?",[O.id]),console.log(src_ms);break;case"list":switch(m.type){case"zmanim":h.data=c("select  id,name from zmanim order by ord,name");break;case"cmds":h.data=c("select * from cmds where matcon=? and switch=?",[m.m,m.s]);break;case"grps":h.data=c("select * from grps order by id");break;case"settings":var J=h.data=[];c("select * from global").forEach(function(e){J.push({name:e.name,desc:e.notes,val:e.val})}),c("select * from grps order by id").forEach(function(e){J.push({name:"grp_"+e.id,desc:"שם קבוצה "+e.id,val:e.name})});break;case"matcons":"grp"in m?h.data=c("select * from matcons where grp=? order by ord,name",[m.grp]):h.data=c("select * from matcons order by ord,name");break;case"summer":h.data=c("select * from summer order by year");break;case"rules":h.data=c("select * from rules where grp=? ",[m.grp]);break;case"switchs":"grp"in m?h.data=c("select * from switchs where grp=? order by ord,name",[m.grp]):h.data=c("select id,name,grp from switchs order by ord,name");break;case"share":var J={m:{},s:{}};c("select * from cmds where share=?",[m.grp]).forEach(function(e){J.m[e.matcon]=1,J.s[e["switch"]]=1}),h.data={m:Object.keys(J.m),s:Object.keys(J.s)};break;case"tmp":var J=c("select hands from days where grp=0 and date=?",[m.date])[0];h.data=J?JSON.parse(J.hands):[];break;default:i(m.type+" is not valid type",s)}break;case"upd":switch(m.type){case"times":h.data=n("zmanim",m.data,"name,base,igul,add,ord","id");break;case"settings":"grp"==m.k.split("_")[0]?(m.k.split("_")[1]||i("params missing"),n("grps",{id:m.k.split("_")[1],name:m.v},"name","id")):n("global",{name:m.k,val:m.v},"val","name");break;case"summer":h.data=n("summer",m.data,"year,begin,end","id");break;case"rules":h.data=n("rules",m.data,"grp,desc,cal_type,begin_m, begin_d,end_m, end_d,params, days,ord","id");break;case"matcons":m.data.color&&"#"==m.data.color[0]&&(m.data.color=m.data.color.substr(1)),h.data=n("matcons",m.data,"name,color,ord","id"),h.data.color="#"+h.data.color;break;case"switchs":h.data=n("switchs",m.data,"out,name,disable,ord,locked,lock_status","id");break;case"cmds":if(m.data.id){var J=c("select * from cmds where id=?",[m.data.id])[0],x=J.share?"share="+J.share:"id="+J.id;delete m.data.id,c("update cmds set ? where "+x,[m.data]),h.data=c("select * from cmds where id=?",[J.id])[0]}else h.data=n("cmds",m.data,"switch, matcon,type,zman,action, time, days","id");break;default:i(m.type+" is not valid type",s)}break;case"del":switch(m.tbl){case"times":c("delete from cmds where type in(1,2) and  zman=?",[m.id]),c("delete from zmanim where id=?",[m.id]);break;case"rules":c("delete from rules where id=?",[m.id]);break;case"cmds":h.data=0;var J=c("select * from cmds where id=?",[m.id])[0];c("delete from cmds where id=?",[m.id]),J&&J.share&&1==c("select count(*) as c from cmds where share=?",[J.share])[0].c&&(c("update cmds set share=0 where share=?",[J.share]),h.data=1);break;case"switchs":c("delete from switchs where id=?",[m.id]),c("delete from cmds where switch=?",[m.id]);break;default:i(m.tbl+" is not valid tbl",s)}break;case"reset":switch(m.type){case"matcon":c("delete from cmds where matcon=? and switch=?",[m.m,m.s]);break;default:i(m.type+" is not valid type")}break;default:i(m.cmd+" is not valid request",s)}o.json(h)}),e.get("/bak",function(r,s){r.body={cmd:"bak"},e.proc(r,s)}),e.get("/index",function(r,s){e.render(s,"status")}),e.get("/sample",function(r,s){e.render(s,"projs",{userName:r.session.login.name,data:c.rst("select * from 0_projects order by id desc")})}),e.get("/man",function(r,s){var t=e.get_login(r);return t.man?void 0:e.redirect(r,"/index")}),n};
//# sourceMappingURL=elec.js.map