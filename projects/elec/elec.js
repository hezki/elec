var yes=require("../../server/yes"),request=require("request"),fs=require("fs"),wait=require("wait.for");module.exports=function(e){var r={host:"localhost",port:3306,user:"root",pass:"power001",db:"electric"},s=0;if("3388"==global.app.get("port")&&fs.existsSync("./server.json")){var t=fs.readFileSync("./server.json").toString();r={mysql:r,server:JSON.parse(t)},s=1}var a=e.initdata(r),o={C:{TITLE:"מפקד החשמל"},DEBUG_IP:[],DEBUG_LOGIN:{},data:a,login:function(e,r,t){try{if(s){var o=a.rst("server","select * from db_0.elec_users where name=? and pass=?",[e,r])[0];return o?t(null,{uid:o.id,uuid:o.uuid}):t("שם משתמש או סיסמא שגויים.ס1")}var d=a.rst('select val from global where name="user1"')[0];if(!d)return t("שם משתמש או סיסמא שגויים.1");if(d=d.val,d!=e)return t("שם משתמש או סיסמא שגויים.2");var c=a.rst('select val from global where name="user1_pass"')[0];if(!c)return t("שם משתמש או סיסמא שגויים.3");if(c=c.val,c!=r)return t("שם משתמש או סיסמא שגויים.4");t(null,{uid:1})}catch(n){console.log("login err",n),t("שגיאת שרת")}}},d={};if(s){console.log("server mode".yellow.bold);var c=require("socket.io")(1117);c.on("connection",function(e){e.on("uuid",function(r){function s(){try{e._uuid=r;var s=a.rst("server","select * from db_0.elec_users where uuid=?",[r])[0];if(!s)throw new Error(r+" is not valid UUID");d[r]=e,a.rst("server","update db_0.elec_users set status=1 where uuid=?",[r]),console.log("client "+s.client+" connect".yellow.bold)}catch(t){console.log("ERR",t)}}wait.launchFiber(s)}),e.on("disconnect",function(){function r(){try{if(!e._uuid)return;var r=e._uuid,s=a.rst("server","select * from db_0.elec_users where uuid=?",[r])[0];if(!s)throw new Error(r+" is not valid UUID");delete d[r],a.rst("server","update db_0.elec_users set status=0 where uuid=?",[r]),console.log("client "+s.client+" disconnect".red.bold)}catch(t){console.log("ERR",t)}}wait.launchFiber(r)})}),e.unload=function(){c.close()}}else if(fs.existsSync("./client.id")){var t=fs.readFileSync("./client.id").toString();console.log("client mode: "+t.yellow.bold);var c=require("socket.io-client").connect("http://infotel.org.il:1117",{forceNew:!0});c.on("connect",function(){c.emit("uuid",t),console.log("c side connect:"+t)}),c.on("disconnet",function(){console.log("c side disconnect")}),c.on("req",function(r,s){console.log("req".green+", body: "+JSON.stringify(r).substr(0,500)),yes.postData(e,r,function(e,r){try{if(console.log("return "+(e?"err":"OK")),e)return console.log(e,e.stack),void s({result:"err",err:e});s(r)}catch(t){console.log(t,t.stack),s({result:"err",err:t&&t.message?t.message:t})}})}),e.unload=function(){c.disconnect()}}return e.proc(function(r,t,a,o){function c(s){e.retErr(s,r,t)}var n=e.get_login(r),i=r.body;if(s){var l=n.uuid;if(console.log("send cmd to client",JSON.stringify(i).substr(0,100)),!l)return c("ACCESS DENIED");d[l]||c("שרת לא זמין");var m=setTimeout(function(){c("שרת לא הגיב בזמן")},15e3);return void d[l].emit("req",i,function(e){clearTimeout(m),t.json(e)})}if(i&&!i.localy)return void request({url:"http://localhost/server.php",method:"POST",body:JSON.stringify(r.body)},function(e,r,s){if(e)return c(e);r.headers["x-chromelogger-data"]&&t.setHeader("X-ChromeLogger-Data",r.headers["x-chromelogger-data"]);var a=JSON.parse(s);if(a||c(s),"error"==a.result)return c(a.error);var o=a.data;return delete a.data,"bak"==i.cmd?t.redirect("http://localhost/baks/"+o):void t.json({result:"OK",data:o,all:a})});var u={result:"OK"},i=r.body;switch(i.cmd){case"init":u.data={switchs:a("select * from switchs order by ord,name"),matcons:a("select * from matcons order by ord,name"),grps:a("select * from grps")},u.data.grps[0]||(u.data.grps[0]="בסיסי");break;case"hand_cmds":switch(i.type){case"del":var h=yes.dt2str("yyy-MM-dd",yes.str2dt(i.date)),f=a("select * from days where grp=0 and date=?",[h])[0];f||c("not found date");var y=JSON.parse(f.hands);if(y){var p=yes.dt2str("hh:mm:ss",yes.str2dt(h+" "+i.t)),b=i.s,g=i.a,w=i.r?1:0,v=[];y.forEach(function(e){e.r&&!w||!e.r&&w?v.push(e):yes.dt2str("hh:mm:ss",yes.str2dt(h+" "+e.t))==p&&e.s==b&&e.a==g||v.push(e)}),a("update days set hands=? where id=?",[JSON.stringify(v),f.id])}break;case"add":i.date&&"now"==i.date&&(i.date=yes.dt2str(new Date)),i.on&&"now"==i.on&&(i.on=yes.dt2str(new Date)),i.off&&"now"==i.off&&(i.off=yes.dt2str(new Date));var y,h=yes.dt2str("yyy-MM-dd",yes.str2dt(i.date)),f=a("select * from days where grp=0 and date=?",[h])[0];f?y=JSON.parse(f.hands):a('insert into days(date,grp)values("'+h+'",0)'),y||(y=[]),i.src&&(y=y.filter(function(e){return console.log(e.src,i.src,e.src!=i.src),e.src!=i.src})),i.on&&y.push({s:i.s,a:1,t:yes.dt2str("hh:mm:ss",yes.str2dt(i.on))}),i.off&&y.push({s:i.s,a:2,t:yes.dt2str("hh:mm:ss",yes.str2dt(i.off))}),i.proc&&i.proc.forEach(function(e){y.push(e)}),a("update days set hands=? where grp=0 and date=?",[JSON.stringify(y),h]);break;default:c("param err")}break;case"share":var k=a("select * from cmds"),_=yes.arr2obj(k,"id");k.forEach(function(e){e.key=[e.type,e.zman,e.action,e.time,e.days].join("_")});var E=_[i.src];srck=E.key,src_ms=E.matcon+"_"+E["switch"];var O={};k.forEach(function(e){e.key==srck&&(O[e.matcon+"_"+e["switch"]]=e.id)});var S={},q={};E.share?a("select * from cmds where share=?",[E.share]).forEach(function(e){S[e.matcon+"_"+e["switch"]]=e.id}):(E.share=a("select max(share) c from cmds")[0].c+1,a("update cmds set share=? where id=?",[E.share,E.id]));var N={type:E.type,zman:E.zman,action:E.action,time:E.time,days:E.days,share:E.share};i.m.push(E.matcon),i.s.push(E["switch"]),i.m.forEach(function(e){i.s.forEach(function(r){e+"_"+r!=src_ms&&(q[e+"_"+r]||(q[e+"_"+r]=1,N.id=S[e+"_"+r],N.id||(N.id=O[e+"_"+r]),N.matcon=e,N["switch"]=r,o("cmds",N,"switch, matcon,type,zman,action, time, days,share","id"),delete S[e+"_"+r]))})}),delete S[src_ms],Object.keys(S).forEach(function(e){a("delete from cmds where id=?",[S[e]])}),Object.keys(q).length||a("update cmds set share=0 where id=?",[E.id]),console.log(src_ms);break;case"list":switch(i.type){case"zmanim":u.data=a("select  id,name from zmanim order by ord,name");break;case"cmds":u.data=a("select * from cmds where matcon=? and switch=?",[i.m,i.s]);break;case"grps":u.data=a("select * from grps");break;case"settings":var j=u.data=[];a("select * from global").forEach(function(e){j.push({name:e.name,desc:e.notes,val:e.val})}),a("select * from grps").forEach(function(e){j.push({name:"grp_"+e.id,desc:"שם קבוצה "+e.id,val:e.name})});break;case"matcons":"grp"in i?u.data=a("select * from matcons where grp=? order by ord,name",[i.grp]):u.data=a("select * from matcons order by ord,name");break;case"summer":u.data=a("select * from summer order by year");break;case"rules":u.data=a("select * from rules where grp=? ",[i.grp]);break;case"switchs":"grp"in i?u.data=a("select * from switchs where grp=? order by ord,name",[i.grp]):u.data=a("select id,name,grp from switchs order by ord,name");break;case"share":var j={m:{},s:{}};a("select * from cmds where share=?",[i.grp]).forEach(function(e){j.m[e.matcon]=1,j.s[e["switch"]]=1}),u.data={m:Object.keys(j.m),s:Object.keys(j.s)};break;case"tmp":var j=a("select hands from days where grp=0 and date=?",[i.date])[0];u.data=j?JSON.parse(j.hands):[];break;default:c(i.type+" is not valid type",r)}break;case"upd":switch(i.type){case"times":u.data=o("zmanim",i.data,"name,base,igul,add,ord","id");break;case"settings":"grp"==i.k.split("_")[0]?(i.k.split("_")[1]||c("params missing"),o("grps",{id:i.k.split("_")[1],name:i.v},"name","id")):o("global",{name:i.k,val:i.v},"val","name");break;case"summer":u.data=o("summer",i.data,"year,begin,end","id");break;case"rules":u.data=o("rules",i.data,"grp,desc,cal_type,begin_m, begin_d,end_m, end_d,params, days,ord","id");break;case"matcons":i.data.color&&"#"==i.data.color[0]&&(i.data.color=i.data.color.substr(1)),u.data=o("matcons",i.data,"name,color,ord","id"),u.data.color="#"+u.data.color;break;case"switchs":u.data=o("switchs",i.data,"out,name,disable,ord,locked,lock_status","id");break;case"cmds":if(i.data.id){var j=a("select * from cmds where id=?",[i.data.id])[0],D=j.share?"share="+j.share:"id="+j.id;delete i.data.id,a("update cmds set ? where "+D,[i.data]),u.data=a("select * from cmds where id=?",[j.id])[0]}else u.data=o("cmds",i.data,"switch, matcon,type,zman,action, time, days","id");break;default:c(i.type+" is not valid type",r)}break;case"del":switch(i.tbl){case"times":a("delete from cmds where type in(1,2) and  zman=?",[i.id]),a("delete from zmanim where id=?",[i.id]);break;case"rules":a("delete from rules where id=?",[i.id]);break;case"cmds":u.data=0;var j=a("select * from cmds where id=?",[i.id])[0];a("delete from cmds where id=?",[i.id]),j&&j.share&&1==a("select count(*) as c from cmds where share=?",[j.share])[0].c&&(a("update cmds set share=0 where share=?",[j.share]),u.data=1);break;case"switchs":a("delete from switchs where id=?",[i.id]),a("delete from cmds where switch=?",[i.id]);break;default:c(i.tbl+" is not valid tbl",r)}break;case"reset":switch(i.type){case"matcon":a("delete from cmds where matcon=? and switch=?",[i.m,i.s]);break;default:c(i.type+" is not valid type")}break;default:c(i.cmd+" is not valid request",r)}t.json(u)}),e.get("/bak",function(r,s){r.body={cmd:"bak"},e.proc(r,s)}),e.get("/index",function(r,s){e.render(s,"status")}),e.get("/sample",function(r,s){e.render(s,"projs",{userName:r.session.login.name,data:a.rst("select * from 0_projects order by id desc")})}),o};
//# sourceMappingURL=elec.js.map