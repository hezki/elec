var dns=require("dns"),old=dns.lookup;dns.lookup=function(e,r,t){return"localhost"==e?(t?t:r)(null,"127.0.0.1",4):void old.apply(this,arguments)};var yes=require("../../server/yes"),request=require("request"),fs=require("fs"),wait=require("wait.for");module.exports=function(e){var r,t={host:"localhost",port:3306,user:"root",pass:"power001",db:"electric"},s="http://localhost/server.php",a=0;if(e.public_urls.push("/info"),"3390"==global.app.get("port")){if(app.get("/",function(e,r){r.redirect("/elec/info")}),fs.existsSync("./server.json")){var o=fs.readFileSync("./server.json").toString();t={mysql:t,server:JSON.parse(o)},a=1}}else if(fs.existsSync("./server.json")){var o=fs.readFileSync("./server.json").toString();t=JSON.parse(o),t.url&&(s=t.url)}var c=e.initdata(t),n={C:{TITLE:"מפקד החשמל"},DEBUG_IP:[],DEBUG_LOGIN:{},data:c,login:function(e,r,t){try{if(a){var s=c.rst("server","select * from db_0.elec_users where name=? and pass=?",[e,r])[0];return s?t(null,{uid:s.id,uuid:s.uuid}):t("שם משתמש או סיסמא שגויים.ס1")}if(fs.existsSync("./client.id")){var o=fs.readFileSync("./client.id").toString().replace(/[\r\n-ba]/g);"f38953342465785710421f0"==o&&t(null,{man:1})}var n=c.rst('select val from global where name="user1"')[0];if(!n)return t("שם משתמש או סיסמא שגויים.1");if(n=n.val,n!=e)return t("שם משתמש או סיסמא שגויים.2");var d=c.rst('select val from global where name="user1_pass"')[0];if(!d)return t("שם משתמש או סיסמא שגויים.3");if(d=d.val,d!=r)return t("שם משתמש או סיסמא שגויים.4");t(null,{uid:1})}catch(i){console.log("login err",i),t("שגיאת שרת")}}},d={};if(a){console.log("server mode".yellow.bold);var i=require("socket.io")(1117);setInterval(function(){Object.keys(d).forEach(function(e){var r=d[e];r&&r.connected&&r.emit("ping")})},3e4),i.on("connection",function(e){e.on("socket_test",function(e,r){console.log("socket_test",e),r(e)}),e.on("ping",function(r){e._uuid&&r==e._uuid||e.emit("what")}),e.on("uuid",function(r){function t(){try{e._uuid=r;var t=c.rst("server","select * from db_0.elec_users where uuid=?",[r])[0];if(!t)throw new Error(r+" is not valid UUID");d[r]=e,d[r]._cname=t.client,c.rst("server","update db_0.elec_users set status=1 where uuid=?",[r]),console.log("client "+t.client+" connect".yellow.bold)}catch(s){console.log("ERR",s)}}console.log("client "+r+" request connect".blue.bold),d[r]?setTimeout(function(){wait.launchFiber(t)},3e4):wait.launchFiber(t)}),e.on("disconnect",function(){function r(){try{if(!e._uuid)return;var r=e._uuid,t=c.rst("server","select * from db_0.elec_users where uuid=?",[r])[0];if(!t)throw new Error(r+" is not valid UUID");delete d[r],c.rst("server","update db_0.elec_users set status=0 where uuid=?",[r]),console.log("client "+t.client+" disconnect".red.bold)}catch(s){console.log("ERR",s)}}wait.launchFiber(r)})}),e.unload=function(){i.close()}}else if(fs.existsSync("./client.id")){var o=fs.readFileSync("./client.id").toString();console.log("client mode: "+o.yellow.bold);var i=require("socket.io-client").connect("http://mefaked.com:1117",{forceNew:!0,transports:["websocket"]});i.on("ping",function(){}),i.on("what",function(){i.emit("uuid",o),console.log("c side connect:"+o)}),i.on("connect",function(){i.emit("uuid",o),console.log("c side connect:"+o)}),i.on("disconnect",function(){console.log("c side disconnect")}),i.on("socket_test",function(e,r){r(e)}),i.on("req",function(r,t){console.log("req".green+", body: "+JSON.stringify(r).substr(0,500)),yes.postData(e,r,function(e,r){try{if(console.log("return "+(e?"err":"OK")),e)return console.log(e,e.stack),void t({result:"err",err:e.message,stack:e.stack});t(r)}catch(s){console.log(s,s.stack),t({result:"err",err:s&&s.message?s.message:s})}})}),r=i,i._uuid=o,e.unload=function(){i.disconnect()}}return e.proc(function(t,o,c,n){function i(r){e.retErr(r,t,o)}var l=e.get_login(t),u=t.body;if(a){var m=l.uuid;if(console.log("send cmd to client",JSON.stringify(u).substr(0,100)),!m)return i("ACCESS DENIED");if(d[m]||i("שרת לא זמין"),u.cmd&&"socket_test"==u.cmd){var f=setTimeout(function(){i("שרת לא הגיב בזמן")},2e3);return void d[m].emit("socket_test",yes.uuid(),function(e){clearTimeout(f),o.json(e)})}var f=setTimeout(function(){i("שרת לא הגיב בזמן")},15e3);return void d[m].emit("req",u,function(e){clearTimeout(f),o.json(e)})}if(u&&!u.localy)return console.log(s.red.bold),void request({url:s,method:"POST",body:JSON.stringify(t.body)},function(e,r,t){if(e)return i(e);r.headers["x-chromelogger-data"]&&o.setHeader("X-ChromeLogger-Data",r.headers["x-chromelogger-data"]);try{var a=JSON.parse(t)}catch(c){throw console.log(s,c,t),new Error(t)}if("error"==a.result)return i(a.error);var n=a.data;return delete a.data,"bak"==u.cmd?o.redirect("http://localhost/baks/"+n):void o.json({result:"OK",data:n,all:a})});var h={result:"OK"},u=t.body;switch(u.cmd){case"socket_test":if(r)return void r.emit("socket_test",r._uuid,function(e){h.data=e,e.json(h)});i("not connect");break;case"init":h.data={switchs:c("select * from switchs order by ord,name"),matcons:c("select * from matcons order by ord,name"),grps:c("select * from grps order by id")},h.data.grps[0]||(h.data.grps[0]="בסיסי");break;case"hand_cmds":switch(u.type){case"del":var p=yes.dt2str("yyy-MM-dd",yes.str2dt(u.date)),y=c("select * from days where grp=0 and date=?",[p])[0];y||i("not found date");var g=JSON.parse(y.hands);if(g){var b=yes.dt2str("hh:mm:ss",yes.str2dt(p+" "+u.t)),w=u.s,v=u.a,k=u.r?1:0,_=[];g.forEach(function(e){e.r&&!k||!e.r&&k?_.push(e):yes.dt2str("hh:mm:ss",yes.str2dt(p+" "+e.t))==b&&e.s==w&&e.a==v||_.push(e)}),c("update days set hands=? where id=?",[JSON.stringify(_),y.id])}break;case"add":u.date&&"now"==u.date&&(u.date=yes.dt2str(new Date)),u.on&&"now"==u.on&&(u.on=yes.dt2str(new Date)),u.off&&"now"==u.off&&(u.off=yes.dt2str(new Date));var g,p=yes.dt2str("yyy-MM-dd",yes.str2dt(u.date)),y=c("select * from days where grp=0 and date=?",[p])[0];y?g=JSON.parse(y.hands):c('insert into days(date,grp)values("'+p+'",0)'),g||(g=[]),u.src&&(g=g.filter(function(e){return console.log(e.src,u.src,e.src!=u.src),e.src!=u.src})),u.on&&g.push({s:u.s,a:1,t:yes.dt2str("hh:mm:ss",yes.str2dt(u.on))}),u.off&&g.push({s:u.s,a:2,t:yes.dt2str("hh:mm:ss",yes.str2dt(u.off))}),u.proc&&u.proc.forEach(function(e){g.push(e)}),c("update days set hands=? where grp=0 and date=?",[JSON.stringify(g),p]);break;default:i("param err")}break;case"share":var S=c("select * from cmds"),E=yes.arr2obj(S,"id");S.forEach(function(e){e.key=[e.type,e.zman,e.action,e.time,e.days].join("_")});var O=E[u.src];srck=O.key,src_ms=O.matcon+"_"+O["switch"];var j={};S.forEach(function(e){e.key==srck&&(j[e.matcon+"_"+e["switch"]]=e.id)});var q={},N={};O.share?c("select * from cmds where share=?",[O.share]).forEach(function(e){q[e.matcon+"_"+e["switch"]]=e.id}):(O.share=c("select max(share) c from cmds")[0].c+1,c("update cmds set share=? where id=?",[O.share,O.id]));var D={type:O.type,zman:O.zman,action:O.action,time:O.time,days:O.days,share:O.share};u.m.push(O.matcon),u.s.push(O["switch"]),u.m.forEach(function(e){u.s.forEach(function(r){e+"_"+r!=src_ms&&(N[e+"_"+r]||(N[e+"_"+r]=1,D.id=q[e+"_"+r],D.id||(D.id=j[e+"_"+r]),D.matcon=e,D["switch"]=r,n("cmds",D,"switch, matcon,type,zman,action, time, days,share","id"),delete q[e+"_"+r]))})}),delete q[src_ms],Object.keys(q).forEach(function(e){c("delete from cmds where id=?",[q[e]])}),Object.keys(N).length||c("update cmds set share=0 where id=?",[O.id]),console.log(src_ms);break;case"list":switch(u.type){case"zmanim":h.data=c("select  id,name from zmanim order by ord,name");break;case"cmds":h.data=c("select * from cmds where matcon=? and switch=?",[u.m,u.s]);break;case"grps":h.data=c("select * from grps order by id");break;case"settings":var J=h.data=[];c("select * from global").forEach(function(e){J.push({name:e.name,desc:e.notes,val:e.val})}),c("select * from grps order by id").forEach(function(e){J.push({name:"grp_"+e.id,desc:"שם קבוצה "+e.id,val:e.name})});break;case"matcons":"grp"in u?h.data=c("select * from matcons where grp=? order by ord,name",[u.grp]):h.data=c("select * from matcons order by ord,name");break;case"summer":h.data=c("select * from summer order by year");break;case"rules":h.data=c("select * from rules where grp=? ",[u.grp]);break;case"switchs":"grp"in u?h.data=c("select * from switchs where grp=? order by ord,name",[u.grp]):h.data=c("select id,name,grp from switchs order by ord,name");break;case"share":var J={m:{},s:{}};c("select * from cmds where share=?",[u.grp]).forEach(function(e){J.m[e.matcon]=1,J.s[e["switch"]]=1}),h.data={m:Object.keys(J.m),s:Object.keys(J.s)};break;case"tmp":var J=c("select hands from days where grp=0 and date=?",[u.date])[0];h.data=J?JSON.parse(J.hands):[];break;default:i(u.type+" is not valid type",t)}break;case"upd":switch(u.type){case"times":h.data=n("zmanim",u.data,"name,base,igul,add,ord","id");break;case"settings":"grp"==u.k.split("_")[0]?(u.k.split("_")[1]||i("params missing"),n("grps",{id:u.k.split("_")[1],name:u.v},"name","id")):n("global",{name:u.k,val:u.v},"val","name");break;case"summer":h.data=n("summer",u.data,"year,begin,end","id");break;case"rules":h.data=n("rules",u.data,"grp,desc,cal_type,begin_m, begin_d,end_m, end_d,params, days,ord","id");break;case"matcons":u.data.color&&"#"==u.data.color[0]&&(u.data.color=u.data.color.substr(1)),h.data=n("matcons",u.data,"name,color,ord","id"),h.data.color="#"+h.data.color;break;case"switchs":h.data=n("switchs",u.data,"out,name,disable,ord,locked,lock_status","id");break;case"cmds":if(u.data.id){var J=c("select * from cmds where id=?",[u.data.id])[0],x=J.share?"share="+J.share:"id="+J.id;delete u.data.id,c("update cmds set ? where "+x,[u.data]),h.data=c("select * from cmds where id=?",[J.id])[0]}else h.data=n("cmds",u.data,"switch, matcon,type,zman,action, time, days","id");break;default:i(u.type+" is not valid type",t)}break;case"del":switch(u.tbl){case"times":c("delete from cmds where type in(1,2) and  zman=?",[u.id]),c("delete from zmanim where id=?",[u.id]);break;case"rules":c("delete from rules where id=?",[u.id]);break;case"cmds":h.data=0;var J=c("select * from cmds where id=?",[u.id])[0];c("delete from cmds where id=?",[u.id]),J&&J.share&&1==c("select count(*) as c from cmds where share=?",[J.share])[0].c&&(c("update cmds set share=0 where share=?",[J.share]),h.data=1);break;case"switchs":c("delete from switchs where id=?",[u.id]),c("delete from cmds where switch=?",[u.id]);break;default:i(u.tbl+" is not valid tbl",t)}break;case"reset":switch(u.type){case"matcon":c("delete from cmds where matcon=? and switch=?",[u.m,u.s]);break;default:i(u.type+" is not valid type")}break;default:i(u.cmd+" is not valid request",t)}o.json(h)}),e.get("/bak",function(r,t){r.body={cmd:"bak"},e.proc(r,t)}),e.get("/index",function(r,t){e.render(t,"status")}),e.get("/sample",function(r,t){e.render(t,"projs",{userName:r.session.login.name,data:c.rst("select * from 0_projects order by id desc")})}),e.get("/man",function(r,t){var s=e.get_login(r);return s.man?void 0:e.redirect(r,"/index")}),n};
//# sourceMappingURL=elec.js.map