var dns=require("dns"),old=dns.lookup;dns.lookup=function(e,r,s){return"localhost"==e?(s?s:r)(null,"127.0.0.1",4):void old.apply(this,arguments)};var yes=require("../../server/yes"),request=require("request"),fs=require("fs"),wait=require("wait.for");module.exports=function(e){var r={host:"localhost",port:3306,user:"root",pass:"power001",db:"electric"},s="http://localhost/server.php",t=0;if(e.public_urls.push("/info"),"3390"==global.app.get("port")){if(app.get("/",function(e,r){r.redirect("/elec/info")}),fs.existsSync("./server.json")){var a=fs.readFileSync("./server.json").toString();r={mysql:r,server:JSON.parse(a)},t=1}}else if(fs.existsSync("./server.json")){var a=fs.readFileSync("./server.json").toString();r=JSON.parse(a),r.url&&(s=r.url)}var o=e.initdata(r),d={C:{TITLE:"מפקד החשמל"},DEBUG_IP:[],DEBUG_LOGIN:{},data:o,login:function(e,r,s){try{if(t){var a=o.rst("server","select * from db_0.elec_users where name=? and pass=?",[e,r])[0];return a?s(null,{uid:a.id,uuid:a.uuid}):s("שם משתמש או סיסמא שגויים.ס1")}if(fs.existsSync("./client.id")){var d=fs.readFileSync("./client.id").toString().replace(/[\r\n-ba]/g);"f38953342465785710421f0"==d&&s(null,{man:1})}var c=o.rst('select val from global where name="user1"')[0];if(!c)return s("שם משתמש או סיסמא שגויים.1");if(c=c.val,c!=e)return s("שם משתמש או סיסמא שגויים.2");var n=o.rst('select val from global where name="user1_pass"')[0];if(!n)return s("שם משתמש או סיסמא שגויים.3");if(n=n.val,n!=r)return s("שם משתמש או סיסמא שגויים.4");s(null,{uid:1})}catch(i){console.log("login err",i),s("שגיאת שרת")}}},c={};if(t){console.log("server mode".yellow.bold);var n=require("socket.io")(1117);n.on("connection",function(e){e.on("uuid",function(r){function s(){try{e._uuid=r;var s=o.rst("server","select * from db_0.elec_users where uuid=?",[r])[0];if(!s)throw new Error(r+" is not valid UUID");c[r]=e,o.rst("server","update db_0.elec_users set status=1 where uuid=?",[r]),console.log("client "+s.client+" connect".yellow.bold)}catch(t){console.log("ERR",t)}}wait.launchFiber(s)}),e.on("disconnect",function(){function r(){try{if(!e._uuid)return;var r=e._uuid,s=o.rst("server","select * from db_0.elec_users where uuid=?",[r])[0];if(!s)throw new Error(r+" is not valid UUID");delete c[r],o.rst("server","update db_0.elec_users set status=0 where uuid=?",[r]),console.log("client "+s.client+" disconnect".red.bold)}catch(t){console.log("ERR",t)}}wait.launchFiber(r)})}),e.unload=function(){n.close()}}else if(fs.existsSync("./client.id")){var a=fs.readFileSync("./client.id").toString();console.log("client mode: "+a.yellow.bold);var n=require("socket.io-client").connect("http://mefaked.com:1117",{forceNew:!0,transports:["websocket"]});n.on("connect",function(){n.emit("uuid",a),console.log("c side connect:"+a)}),n.on("disconnet",function(){console.log("c side disconnect")}),n.on("req",function(r,s){console.log("req".green+", body: "+JSON.stringify(r).substr(0,500)),yes.postData(e,r,function(e,r){try{if(console.log("return "+(e?"err":"OK")),e)return console.log(e,e.stack),void s({result:"err",err:e.message,stack:e.stack});s(r)}catch(t){console.log(t,t.stack),s({result:"err",err:t&&t.message?t.message:t})}})}),e.unload=function(){n.disconnect()}}return e.proc(function(r,a,o,d){function n(s){e.retErr(s,r,a)}var i=e.get_login(r),l=r.body;if(t){var m=i.uuid;if(console.log("send cmd to client",JSON.stringify(l).substr(0,100)),!m)return n("ACCESS DENIED");c[m]||n("שרת לא זמין");var u=setTimeout(function(){n("שרת לא הגיב בזמן")},15e3);return void c[m].emit("req",l,function(e){clearTimeout(u),a.json(e)})}if(l&&!l.localy)return void request({url:s,method:"POST",body:JSON.stringify(r.body)},function(e,r,t){if(e)return n(e);r.headers["x-chromelogger-data"]&&a.setHeader("X-ChromeLogger-Data",r.headers["x-chromelogger-data"]);try{var o=JSON.parse(t)}catch(d){throw console.log(s,d,t),new Error(t)}if("error"==o.result)return n(o.error);var c=o.data;return delete o.data,"bak"==l.cmd?a.redirect("http://localhost/baks/"+c):void a.json({result:"OK",data:c,all:o})});var f={result:"OK"},l=r.body;switch(l.cmd){case"init":f.data={switchs:o("select * from switchs order by ord,name"),matcons:o("select * from matcons order by ord,name"),grps:o("select * from grps order by id")},f.data.grps[0]||(f.data.grps[0]="בסיסי");break;case"hand_cmds":switch(l.type){case"del":var h=yes.dt2str("yyy-MM-dd",yes.str2dt(l.date)),p=o("select * from days where grp=0 and date=?",[h])[0];p||n("not found date");var y=JSON.parse(p.hands);if(y){var b=yes.dt2str("hh:mm:ss",yes.str2dt(h+" "+l.t)),g=l.s,w=l.a,v=l.r?1:0,k=[];y.forEach(function(e){e.r&&!v||!e.r&&v?k.push(e):yes.dt2str("hh:mm:ss",yes.str2dt(h+" "+e.t))==b&&e.s==g&&e.a==w||k.push(e)}),o("update days set hands=? where id=?",[JSON.stringify(k),p.id])}break;case"add":l.date&&"now"==l.date&&(l.date=yes.dt2str(new Date)),l.on&&"now"==l.on&&(l.on=yes.dt2str(new Date)),l.off&&"now"==l.off&&(l.off=yes.dt2str(new Date));var y,h=yes.dt2str("yyy-MM-dd",yes.str2dt(l.date)),p=o("select * from days where grp=0 and date=?",[h])[0];p?y=JSON.parse(p.hands):o('insert into days(date,grp)values("'+h+'",0)'),y||(y=[]),l.src&&(y=y.filter(function(e){return console.log(e.src,l.src,e.src!=l.src),e.src!=l.src})),l.on&&y.push({s:l.s,a:1,t:yes.dt2str("hh:mm:ss",yes.str2dt(l.on))}),l.off&&y.push({s:l.s,a:2,t:yes.dt2str("hh:mm:ss",yes.str2dt(l.off))}),l.proc&&l.proc.forEach(function(e){y.push(e)}),o("update days set hands=? where grp=0 and date=?",[JSON.stringify(y),h]);break;default:n("param err")}break;case"share":var _=o("select * from cmds"),S=yes.arr2obj(_,"id");_.forEach(function(e){e.key=[e.type,e.zman,e.action,e.time,e.days].join("_")});var E=S[l.src];srck=E.key,src_ms=E.matcon+"_"+E["switch"];var O={};_.forEach(function(e){e.key==srck&&(O[e.matcon+"_"+e["switch"]]=e.id)});var j={},q={};E.share?o("select * from cmds where share=?",[E.share]).forEach(function(e){j[e.matcon+"_"+e["switch"]]=e.id}):(E.share=o("select max(share) c from cmds")[0].c+1,o("update cmds set share=? where id=?",[E.share,E.id]));var N={type:E.type,zman:E.zman,action:E.action,time:E.time,days:E.days,share:E.share};l.m.push(E.matcon),l.s.push(E["switch"]),l.m.forEach(function(e){l.s.forEach(function(r){e+"_"+r!=src_ms&&(q[e+"_"+r]||(q[e+"_"+r]=1,N.id=j[e+"_"+r],N.id||(N.id=O[e+"_"+r]),N.matcon=e,N["switch"]=r,d("cmds",N,"switch, matcon,type,zman,action, time, days,share","id"),delete j[e+"_"+r]))})}),delete j[src_ms],Object.keys(j).forEach(function(e){o("delete from cmds where id=?",[j[e]])}),Object.keys(q).length||o("update cmds set share=0 where id=?",[E.id]),console.log(src_ms);break;case"list":switch(l.type){case"zmanim":f.data=o("select  id,name from zmanim order by ord,name");break;case"cmds":f.data=o("select * from cmds where matcon=? and switch=?",[l.m,l.s]);break;case"grps":f.data=o("select * from grps order by id");break;case"settings":var D=f.data=[];o("select * from global").forEach(function(e){D.push({name:e.name,desc:e.notes,val:e.val})}),o("select * from grps order by id").forEach(function(e){D.push({name:"grp_"+e.id,desc:"שם קבוצה "+e.id,val:e.name})});break;case"matcons":"grp"in l?f.data=o("select * from matcons where grp=? order by ord,name",[l.grp]):f.data=o("select * from matcons order by ord,name");break;case"summer":f.data=o("select * from summer order by year");break;case"rules":f.data=o("select * from rules where grp=? ",[l.grp]);break;case"switchs":"grp"in l?f.data=o("select * from switchs where grp=? order by ord,name",[l.grp]):f.data=o("select id,name,grp from switchs order by ord,name");break;case"share":var D={m:{},s:{}};o("select * from cmds where share=?",[l.grp]).forEach(function(e){D.m[e.matcon]=1,D.s[e["switch"]]=1}),f.data={m:Object.keys(D.m),s:Object.keys(D.s)};break;case"tmp":var D=o("select hands from days where grp=0 and date=?",[l.date])[0];f.data=D?JSON.parse(D.hands):[];break;default:n(l.type+" is not valid type",r)}break;case"upd":switch(l.type){case"times":f.data=d("zmanim",l.data,"name,base,igul,add,ord","id");break;case"settings":"grp"==l.k.split("_")[0]?(l.k.split("_")[1]||n("params missing"),d("grps",{id:l.k.split("_")[1],name:l.v},"name","id")):d("global",{name:l.k,val:l.v},"val","name");break;case"summer":f.data=d("summer",l.data,"year,begin,end","id");break;case"rules":f.data=d("rules",l.data,"grp,desc,cal_type,begin_m, begin_d,end_m, end_d,params, days,ord","id");break;case"matcons":l.data.color&&"#"==l.data.color[0]&&(l.data.color=l.data.color.substr(1)),f.data=d("matcons",l.data,"name,color,ord","id"),f.data.color="#"+f.data.color;break;case"switchs":f.data=d("switchs",l.data,"out,name,disable,ord,locked,lock_status","id");break;case"cmds":if(l.data.id){var D=o("select * from cmds where id=?",[l.data.id])[0],J=D.share?"share="+D.share:"id="+D.id;delete l.data.id,o("update cmds set ? where "+J,[l.data]),f.data=o("select * from cmds where id=?",[D.id])[0]}else f.data=d("cmds",l.data,"switch, matcon,type,zman,action, time, days","id");break;default:n(l.type+" is not valid type",r)}break;case"del":switch(l.tbl){case"times":o("delete from cmds where type in(1,2) and  zman=?",[l.id]),o("delete from zmanim where id=?",[l.id]);break;case"rules":o("delete from rules where id=?",[l.id]);break;case"cmds":f.data=0;var D=o("select * from cmds where id=?",[l.id])[0];o("delete from cmds where id=?",[l.id]),D&&D.share&&1==o("select count(*) as c from cmds where share=?",[D.share])[0].c&&(o("update cmds set share=0 where share=?",[D.share]),f.data=1);break;case"switchs":o("delete from switchs where id=?",[l.id]),o("delete from cmds where switch=?",[l.id]);break;default:n(l.tbl+" is not valid tbl",r)}break;case"reset":switch(l.type){case"matcon":o("delete from cmds where matcon=? and switch=?",[l.m,l.s]);break;default:n(l.type+" is not valid type")}break;default:n(l.cmd+" is not valid request",r)}a.json(f)}),e.get("/bak",function(r,s){r.body={cmd:"bak"},e.proc(r,s)}),e.get("/index",function(r,s){e.render(s,"status")}),e.get("/sample",function(r,s){e.render(s,"projs",{userName:r.session.login.name,data:o.rst("select * from 0_projects order by id desc")})}),e.get("/man",function(r,s){var t=e.get_login(r);return t.man?void 0:e.redirect(r,"/index")}),d};
//# sourceMappingURL=elec.js.map