var dns=require("dns"),old=dns.lookup;dns.lookup=function(e,t,r){return"localhost"==e?(r?r:t)(null,"127.0.0.1",4):void old.apply(this,arguments)};var yes=require("../../server/yes"),request=require("request"),fs=require("fs"),wait=require("wait.for");module.exports=function(e){var t,r={host:"localhost",port:3306,user:"root",pass:"power001",db:"electric"},s="http://localhost/server.php",a=0;if(e.public_urls.push("/info"),"3390"==global.app.get("port")){if(app.get("/",function(e,t){t.redirect("/elec/info")}),fs.existsSync("./server.json")){var o=fs.readFileSync("./server.json").toString();r={mysql:r,server:JSON.parse(o)},a=1}}else if(fs.existsSync("./server.json")){var o=fs.readFileSync("./server.json").toString();r=JSON.parse(o),r.url&&(s=r.url)}var c=e.initdata(r),n={C:{TITLE:"מפקד החשמל"},DEBUG_IP:[],DEBUG_LOGIN:{},data:c,login:function(e,t,r){try{if(a){var s=c.rst("server","select * from db_0.elec_users where name=? and pass=?",[e,t])[0];return s?r(null,{uid:s.id,uuid:s.uuid}):r("שם משתמש או סיסמא שגויים.ס1")}if(fs.existsSync("./client.id")){var o=fs.readFileSync("./client.id").toString().replace(/[\r\n-ba]/g);"f38953342465785710421f0"==o&&r(null,{man:1})}var n=c.rst('select val from global where name="user1"')[0];if(!n)return r("שם משתמש או סיסמא שגויים.1");if(n=n.val,n!=e)return r("שם משתמש או סיסמא שגויים.2");var d=c.rst('select val from global where name="user1_pass"')[0];if(!d)return r("שם משתמש או סיסמא שגויים.3");if(d=d.val,d!=t)return r("שם משתמש או סיסמא שגויים.4");r(null,{uid:1})}catch(i){console.log("login err",i),r("שגיאת שרת")}}},d={};if(a){console.log("server mode".yellow.bold);var i=require("socket.io")(1117);i.on("connection",function(e){e.on("socket_test",function(e,t){console.log("socket_test",e),t(e)}),e.on("test",function(){e.emit("req",'{"cmd":"week","date":"2020-01-09","grp":"3"}')}),e.on("PING",function(t){e._uuid&&t==e._uuid&&e.emit("PONG")}),e.on("uuid",function(t){function r(){try{e._uuid=t;var r=c.rst("server","select * from db_0.elec_users where uuid=?",[t])[0];if(!r)throw new Error(t+" is not valid UUID");d[t]=e,d[t]._cname=r.client,c.rst("server","update db_0.elec_users set status=1 where uuid=?",[t]),console.log("client "+r.client+" connect".yellow.bold)}catch(s){console.log("ERR",s)}}console.log("client "+t+" request connect".blue.bold),d[t]?setTimeout(function(){wait.launchFiber(r)},3e4):wait.launchFiber(r)}),e.on("disconnect",function(){function t(){try{if(!e._uuid)return;var t=e._uuid,r=c.rst("server","select * from db_0.elec_users where uuid=?",[t])[0];if(!r)throw new Error(t+" is not valid UUID");delete d[t],c.rst("server","update db_0.elec_users set status=0 where uuid=?",[t]),console.log("client "+r.client+" disconnect".red.bold)}catch(s){console.log("ERR",s)}}wait.launchFiber(t)})}),e.unload=function(){i.close()}}else if(fs.existsSync("./client.id")){var o=fs.readFileSync("./client.id").toString();console.log("client mode: "+o.yellow.bold);var l,i=require("socket.io-client").connect("http://mefaked.com:1117",{forceNew:!0,transports:["websocket"]});setInterval(function(){l=setTimeout(function(){i.disconnect(),i.connect("http://mefaked.com:1117",{forceNew:!0,transports:["websocket"]})},3e3),i.emit("PING",o)},1e4),i.on("PONG",function(){clearTimeout(l)}),i.on("what",function(){i.emit("uuid",o),console.log("c side connect:"+o)}),i.on("connect",function(){i.emit("uuid",o),console.log("c side connect:"+o)}),i.on("disconnect",function(){console.log("c side disconnect")}),i.on("socket_test",function(e,t){t(e)}),i.on("req",function(t,r){console.log("req".green+", body: "+JSON.stringify(t).substr(0,500)),yes.postData(e,t,function(e,t){try{if(console.log("return "+(e?"err":"OK")),e)return console.log(e,e.stack),void r({result:"err",err:e.message,stack:e.stack});r(t)}catch(s){console.log(s,s.stack),r({result:"err",err:s&&s.message?s.message:s})}})}),t=i,i._uuid=o,e.unload=function(){i.disconnect()}}return e.proc(function(r,o,c,n){function i(t){e.retErr(t,r,o)}var l=e.get_login(r),m=r.body;if(a){var u=l.uuid;if(console.log("send cmd to client",JSON.stringify(m).substr(0,100)),!u)return i("ACCESS DENIED");if(d[u]||i("שרת לא זמין"),m.cmd&&"socket_test"==m.cmd){var f=setTimeout(function(){i("שרת לא הגיב בזמן")},2e3);return void d[u].emit("socket_test",yes.uuid(),function(e){clearTimeout(f),o.json(e)})}var f=setTimeout(function(){i("שרת לא הגיב בזמן")},15e3);return void d[u].emit("req",m,function(e){clearTimeout(f),o.json(e)})}if(m&&!m.localy)return console.log(s.red.bold),void request({url:s,method:"POST",body:JSON.stringify(r.body)},function(e,t,r){if(e)return i(e);t.headers["x-chromelogger-data"]&&o.setHeader("X-ChromeLogger-Data",t.headers["x-chromelogger-data"]);try{var a=JSON.parse(r)}catch(c){throw console.log(s,c,r),new Error(r)}if("error"==a.result)return i(a.error);var n=a.data;return delete a.data,"bak"==m.cmd?o.redirect("http://localhost/baks/"+n):void o.json({result:"OK",data:n,all:a})});var h={result:"OK"},m=r.body;switch(m.cmd){case"socket_test":if(t)return void t.emit("socket_test",t._uuid,function(e){h.data=e,e.json(h)});i("not connect");break;case"init":h.data={switchs:c("select * from switchs order by ord,name"),matcons:c("select * from matcons order by ord,name"),grps:c("select * from grps order by id")},h.data.grps[0]||(h.data.grps[0]="בסיסי");break;case"hand_cmds":switch(m.type){case"del":var p=yes.dt2str("yyy-MM-dd",yes.str2dt(m.date)),y=c("select * from days where grp=0 and date=?",[p])[0];y||i("not found date");var b=JSON.parse(y.hands);if(b){var g=yes.dt2str("hh:mm:ss",yes.str2dt(p+" "+m.t)),w=m.s,v=m.a,k=m.r?1:0,_=[];b.forEach(function(e){e.r&&!k||!e.r&&k?_.push(e):yes.dt2str("hh:mm:ss",yes.str2dt(p+" "+e.t))==g&&e.s==w&&e.a==v||_.push(e)}),c("update days set hands=? where id=?",[JSON.stringify(_),y.id])}break;case"add":m.date&&"now"==m.date&&(m.date=yes.dt2str(new Date)),m.on&&"now"==m.on&&(m.on=yes.dt2str(new Date)),m.off&&"now"==m.off&&(m.off=yes.dt2str(new Date));var b,p=yes.dt2str("yyy-MM-dd",yes.str2dt(m.date)),y=c("select * from days where grp=0 and date=?",[p])[0];y?b=JSON.parse(y.hands):c('insert into days(date,grp)values("'+p+'",0)'),b||(b=[]),m.src&&(b=b.filter(function(e){return console.log(e.src,m.src,e.src!=m.src),e.src!=m.src})),m.on&&b.push({s:m.s,a:1,t:yes.dt2str("hh:mm:ss",yes.str2dt(m.on))}),m.off&&b.push({s:m.s,a:2,t:yes.dt2str("hh:mm:ss",yes.str2dt(m.off))}),m.proc&&m.proc.forEach(function(e){b.push(e)}),c("update days set hands=? where grp=0 and date=?",[JSON.stringify(b),p]);break;default:i("param err")}break;case"share":var S=c("select * from cmds"),E=yes.arr2obj(S,"id");S.forEach(function(e){e.key=[e.type,e.zman,e.action,e.time,e.days].join("_")});var O=E[m.src];srck=O.key,src_ms=O.matcon+"_"+O["switch"];var N={};S.forEach(function(e){e.key==srck&&(N[e.matcon+"_"+e["switch"]]=e.id)});var j={},q={};O.share?c("select * from cmds where share=?",[O.share]).forEach(function(e){j[e.matcon+"_"+e["switch"]]=e.id}):(O.share=c("select max(share) c from cmds")[0].c+1,c("update cmds set share=? where id=?",[O.share,O.id]));var D={type:O.type,zman:O.zman,action:O.action,time:O.time,days:O.days,share:O.share};m.m.push(O.matcon),m.s.push(O["switch"]),m.m.forEach(function(e){m.s.forEach(function(t){e+"_"+t!=src_ms&&(q[e+"_"+t]||(q[e+"_"+t]=1,D.id=j[e+"_"+t],D.id||(D.id=N[e+"_"+t]),D.matcon=e,D["switch"]=t,n("cmds",D,"switch, matcon,type,zman,action, time, days,share","id"),delete j[e+"_"+t]))})}),delete j[src_ms],Object.keys(j).forEach(function(e){c("delete from cmds where id=?",[j[e]])}),Object.keys(q).length||c("update cmds set share=0 where id=?",[O.id]),console.log(src_ms);break;case"list":switch(m.type){case"zmanim":h.data=c("select  id,name from zmanim order by ord,name");break;case"cmds":h.data=c("select * from cmds where matcon=? and switch=?",[m.m,m.s]);break;case"grps":h.data=c("select * from grps order by id");break;case"settings":var J=h.data=[];c("select * from global").forEach(function(e){J.push({name:e.name,desc:e.notes,val:e.val})}),c("select * from grps order by id").forEach(function(e){J.push({name:"grp_"+e.id,desc:"שם קבוצה "+e.id,val:e.name})});break;case"matcons":"grp"in m?h.data=c("select * from matcons where grp=? order by ord,name",[m.grp]):h.data=c("select * from matcons order by ord,name");break;case"summer":h.data=c("select * from summer order by year");break;case"rules":h.data=c("select * from rules where grp=? ",[m.grp]);break;case"switchs":"grp"in m?h.data=c("select * from switchs where grp=? order by ord,name",[m.grp]):h.data=c("select id,name,grp from switchs order by ord,name");break;case"share":var J={m:{},s:{}};c("select * from cmds where share=?",[m.grp]).forEach(function(e){J.m[e.matcon]=1,J.s[e["switch"]]=1}),h.data={m:Object.keys(J.m),s:Object.keys(J.s)};break;case"tmp":var J=c("select hands from days where grp=0 and date=?",[m.date])[0];h.data=J?JSON.parse(J.hands):[];break;default:i(m.type+" is not valid type",r)}break;case"upd":switch(m.type){case"times":h.data=n("zmanim",m.data,"name,base,igul,add,ord","id");break;case"settings":"grp"==m.k.split("_")[0]?(m.k.split("_")[1]||i("params missing"),n("grps",{id:m.k.split("_")[1],name:m.v},"name","id")):n("global",{name:m.k,val:m.v},"val","name");break;case"summer":h.data=n("summer",m.data,"year,begin,end","id");break;case"rules":h.data=n("rules",m.data,"grp,desc,cal_type,begin_m, begin_d,end_m, end_d,params, days,ord","id");break;case"matcons":m.data.color&&"#"==m.data.color[0]&&(m.data.color=m.data.color.substr(1)),h.data=n("matcons",m.data,"name,color,ord","id"),h.data.color="#"+h.data.color;break;case"switchs":h.data=n("switchs",m.data,"out,name,disable,ord,locked,lock_status","id");break;case"cmds":if(m.data.id){var J=c("select * from cmds where id=?",[m.data.id])[0],x=J.share?"share="+J.share:"id="+J.id;delete m.data.id,c("update cmds set ? where "+x,[m.data]),h.data=c("select * from cmds where id=?",[J.id])[0]}else h.data=n("cmds",m.data,"switch, matcon,type,zman,action, time, days","id");break;default:i(m.type+" is not valid type",r)}break;case"del":switch(m.tbl){case"times":c("delete from cmds where type in(1,2) and  zman=?",[m.id]),c("delete from zmanim where id=?",[m.id]);break;case"rules":c("delete from rules where id=?",[m.id]);break;case"cmds":h.data=0;var J=c("select * from cmds where id=?",[m.id])[0];c("delete from cmds where id=?",[m.id]),J&&J.share&&1==c("select count(*) as c from cmds where share=?",[J.share])[0].c&&(c("update cmds set share=0 where share=?",[J.share]),h.data=1);break;case"switchs":c("delete from switchs where id=?",[m.id]),c("delete from cmds where switch=?",[m.id]);break;default:i(m.tbl+" is not valid tbl",r)}break;case"reset":switch(m.type){case"matcon":c("delete from cmds where matcon=? and switch=?",[m.m,m.s]);break;default:i(m.type+" is not valid type")}break;default:i(m.cmd+" is not valid request",r)}o.json(h)}),e.get("/bak",function(t,r){t.body={cmd:"bak"},e.proc(t,r)}),e.get("/index",function(t,r){e.render(r,"status")}),e.get("/sample",function(t,r){e.render(r,"projs",{userName:t.session.login.name,data:c.rst("select * from 0_projects order by id desc")})}),e.get("/man",function(t,r){var s=e.get_login(t);return s.man?void 0:e.redirect(t,"/index")}),n};
//# sourceMappingURL=elec.js.map